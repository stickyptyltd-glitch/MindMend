<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Analytics - MindMend Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .analytics-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
            transition: transform 0.2s ease;
        }
        .metric-card:hover { transform: translateY(-3px); }
        .metric-value {
            font-size: 3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            color: #6c757d;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .metric-change {
            font-size: 0.9rem;
            font-weight: 500;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .period-selector {
            background: white;
            border-radius: 10px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .period-btn {
            border: none;
            background: transparent;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: #6c757d;
        }
        .period-btn.active {
            background: #28a745;
            color: white;
        }
        .period-btn:hover:not(.active) {
            background: #f8f9fa;
        }
        .insights-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }
        .ltv-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 30%);
            color: #e65100;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        .churn-indicator {
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
        }
        .churn-low { background: #d4edda; color: #155724; }
        .churn-medium { background: #fff3cd; color: #856404; }
        .churn-high { background: #f8d7da; color: #721c24; }
        .revenue-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .revenue-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-performance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .performance-bar {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .performance-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="analytics-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>Subscription Analytics</h1>
                    <p class="mb-0">Comprehensive revenue and subscription performance insights</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="period-selector">
                        <button class="period-btn {{ 'active' if period == '7d' else '' }}" onclick="changePeriod('7d')">7 Days</button>
                        <button class="period-btn {{ 'active' if period == '30d' else '' }}" onclick="changePeriod('30d')">30 Days</button>
                        <button class="period-btn {{ 'active' if period == '90d' else '' }}" onclick="changePeriod('90d')">90 Days</button>
                        <button class="period-btn {{ 'active' if period == '1y' else '' }}" onclick="changePeriod('1y')">1 Year</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Key Revenue Metrics -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">${{ "{:,.0f}".format(analytics.revenue_analytics.total_revenue) }}</div>
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-change text-{{ 'success' if analytics.revenue_analytics.growth_rate > 0 else 'danger' }}">
                        <i class="fas fa-arrow-{{ 'up' if analytics.revenue_analytics.growth_rate > 0 else 'down' }}"></i>
                        {{ analytics.revenue_analytics.growth_rate }}% vs previous
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">${{ "{:,.0f}".format(analytics.revenue_analytics.monthly_recurring_revenue) }}</div>
                    <div class="metric-label">Monthly Recurring Revenue</div>
                    <div class="metric-change text-muted">
                        <i class="fas fa-sync-alt"></i>
                        Recurring Base
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">${{ "{:.2f}".format(analytics.revenue_analytics.average_payment) }}</div>
                    <div class="metric-label">Average Payment</div>
                    <div class="metric-change text-muted">
                        <i class="fas fa-receipt"></i>
                        {{ analytics.revenue_analytics.payment_count }} Payments
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ "%.1f"|format(analytics.churn_analytics.churn_rate) }}%</div>
                    <div class="metric-label">Churn Rate</div>
                    <div class="churn-indicator churn-{{ 'low' if analytics.churn_analytics.churn_rate < 5 else 'medium' if analytics.churn_analytics.churn_rate < 10 else 'high' }}">
                        {{ "Excellent" if analytics.churn_analytics.churn_rate < 5 else "Good" if analytics.churn_analytics.churn_rate < 10 else "Needs Attention" }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Charts -->
        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-area me-2 text-success"></i>Revenue Trend</h5>
                    <canvas id="revenueChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie me-2 text-success"></i>Tier Distribution</h5>
                    <canvas id="tierChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Subscription Growth & Churn -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line me-2 text-info"></i>Subscription Growth</h5>
                    <div class="row mb-3">
                        <div class="col-6 text-center">
                            <div class="h3 text-success">+{{ analytics.subscription_growth.new_subscriptions }}</div>
                            <small class="text-muted">New This Period</small>
                        </div>
                        <div class="col-6 text-center">
                            <div class="h3 text-danger">-{{ analytics.subscription_growth.cancellations }}</div>
                            <small class="text-muted">Canceled</small>
                        </div>
                    </div>
                    <canvas id="growthChart" height="150"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar me-2 text-warning"></i>Payment Success Rate</h5>
                    <div class="text-center mb-3">
                        <div class="display-4 text-{{ 'success' if analytics.payment_analytics.success_rate > 90 else 'warning' if analytics.payment_analytics.success_rate > 80 else 'danger' }}">
                            {{ "%.1f"|format(analytics.payment_analytics.success_rate) }}%
                        </div>
                        <small class="text-muted">
                            {{ analytics.payment_analytics.successful_payments }} successful,
                            {{ analytics.payment_analytics.failed_payments }} failed
                        </small>
                    </div>
                    <canvas id="paymentChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- Tier Performance -->
        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5><i class="fas fa-layer-group me-2 text-primary"></i>Tier Performance Analysis</h5>

                    {% for tier, count in analytics.tier_distribution.items() %}
                    <div class="tier-performance">
                        <div>
                            <strong class="text-capitalize">{{ tier }}</strong>
                            <br><small class="text-muted">{{ count }} active subscriptions</small>
                        </div>
                        <div>
                            {% set ltv = analytics.ltv_analytics.ltv_by_tier.get(tier, 0) %}
                            <strong>${{ "%.0f"|format(ltv) }}</strong>
                            <br><small class="text-muted">LTV</small>
                        </div>
                        <div>
                            <div class="performance-bar">
                                <div class="performance-fill" style="width: {{ (count / analytics.tier_distribution.values()|sum * 100)|round }}%"></div>
                            </div>
                            <small class="text-muted">{{ (count / analytics.tier_distribution.values()|sum * 100)|round }}%</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-lg-4">
                <div class="ltv-card">
                    <h5><i class="fas fa-chart-pie me-2"></i>Customer Lifetime Value</h5>
                    <div class="display-4 fw-bold mb-2">
                        ${{ "{:,.0f}".format(analytics.ltv_analytics.average_ltv) }}
                    </div>
                    <p class="mb-3">Average Customer LTV</p>

                    <div class="revenue-breakdown">
                        {% for tier, ltv in analytics.ltv_analytics.ltv_by_tier.items() %}
                        <div class="revenue-item">
                            <strong class="text-capitalize">{{ tier }}</strong>
                            <div class="h5 text-success">${{ "{:.0f}".format(ltv) }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Insights -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-lightbulb me-2 text-warning"></i>Business Insights & Recommendations</h5>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="insights-card">
                                <h6><i class="fas fa-arrow-up me-2"></i>Revenue Growth</h6>
                                {% if analytics.revenue_analytics.growth_rate > 10 %}
                                <p class="mb-1"><strong>Excellent Growth!</strong> Revenue increased by {{ analytics.revenue_analytics.growth_rate }}%</p>
                                <small>Continue current strategies and consider scaling marketing efforts.</small>
                                {% elif analytics.revenue_analytics.growth_rate > 0 %}
                                <p class="mb-1"><strong>Positive Trend:</strong> Revenue grew {{ analytics.revenue_analytics.growth_rate }}%</p>
                                <small>Look for optimization opportunities to accelerate growth.</small>
                                {% else %}
                                <p class="mb-1"><strong>Attention Needed:</strong> Revenue declined {{ abs(analytics.revenue_analytics.growth_rate) }}%</p>
                                <small>Review pricing strategy and customer acquisition channels.</small>
                                {% endif %}
                            </div>

                            <div class="insights-card">
                                <h6><i class="fas fa-users me-2"></i>Subscription Health</h6>
                                {% if analytics.churn_analytics.churn_rate < 5 %}
                                <p class="mb-1"><strong>Excellent Retention:</strong> Low churn rate of {{ "%.1f"|format(analytics.churn_analytics.churn_rate) }}%</p>
                                <small>Focus on upselling and expanding successful customer segments.</small>
                                {% elif analytics.churn_analytics.churn_rate < 10 %}
                                <p class="mb-1"><strong>Good Retention:</strong> Manageable churn at {{ "%.1f"|format(analytics.churn_analytics.churn_rate) }}%</p>
                                <small>Implement retention campaigns for at-risk customers.</small>
                                {% else %}
                                <p class="mb-1"><strong>High Churn Alert:</strong> {{ "%.1f"|format(analytics.churn_analytics.churn_rate) }}% churn needs attention</p>
                                <small>Urgent: Review customer satisfaction and product value.</small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="insights-card">
                                <h6><i class="fas fa-dollar-sign me-2"></i>Revenue Optimization</h6>
                                {% set highest_tier = analytics.ltv_analytics.ltv_by_tier|dictsort(by='value')|reverse|first %}
                                <p class="mb-1"><strong>Top Performer:</strong> {{ highest_tier[0].title() }} tier (${{ "{:.0f}".format(highest_tier[1]) }} LTV)</p>
                                <small>Focus marketing efforts on acquiring more {{ highest_tier[0] }} subscribers.</small>
                            </div>

                            <div class="insights-card">
                                <h6><i class="fas fa-credit-card me-2"></i>Payment Performance</h6>
                                {% if analytics.payment_analytics.success_rate > 95 %}
                                <p class="mb-1"><strong>Excellent:</strong> {{ "%.1f"|format(analytics.payment_analytics.success_rate) }}% payment success</p>
                                <small>Payment system is performing optimally.</small>
                                {% elif analytics.payment_analytics.success_rate > 90 %}
                                <p class="mb-1"><strong>Good:</strong> {{ "%.1f"|format(analytics.payment_analytics.success_rate) }}% payment success</p>
                                <small>Monitor failed payments and consider retry mechanisms.</small>
                                {% else %}
                                <p class="mb-1"><strong>Action Required:</strong> {{ "%.1f"|format(analytics.payment_analytics.success_rate) }}% success rate</p>
                                <small>Investigate payment failures and improve processing.</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-tools me-2 text-primary"></i>Quick Actions</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.subscriptions_list', status='past_due') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Past Due Subscriptions
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.subscriptions_list', tier='free') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-arrow-up me-2"></i>
                                Upgrade Opportunities
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.subscriptions_export') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-download me-2"></i>
                                Export Revenue Data
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.subscription_create') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-plus me-2"></i>
                                Create Subscription
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-5">
            <a href="{{ url_for('admin.subscriptions_list') }}" class="btn btn-success btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to Subscription Management
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart.js configuration
        Chart.defaults.color = '#6c757d';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

        // Revenue Trend Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        fetch(`/admin/api/subscriptions/charts?type=revenue&period={{ period }}`)
            .then(response => response.json())
            .then(data => {
                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Daily Revenue',
                            data: data.data,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            });

        // Tier Distribution Chart
        const tierCtx = document.getElementById('tierChart').getContext('2d');
        const tierData = {{ analytics.tier_distribution | tojson }};
        new Chart(tierCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(tierData).map(tier => tier.charAt(0).toUpperCase() + tier.slice(1)),
                datasets: [{
                    data: Object.values(tierData),
                    backgroundColor: ['#6c757d', '#17a2b8', '#28a745', '#6f42c1']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Subscription Growth Chart
        const growthCtx = document.getElementById('growthChart').getContext('2d');
        fetch(`/admin/api/subscriptions/charts?type=growth&period={{ period }}`)
            .then(response => response.json())
            .then(data => {
                new Chart(growthCtx, {
                    type: 'bar',
                    data: {
                        labels: data.new_subscriptions.labels,
                        datasets: [{
                            label: 'New Subscriptions',
                            data: data.new_subscriptions.data,
                            backgroundColor: '#28a745'
                        }, {
                            label: 'Churned',
                            data: data.churn.data || [],
                            backgroundColor: '#dc3545'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            });

        // Payment Success Chart
        const paymentCtx = document.getElementById('paymentChart').getContext('2d');
        new Chart(paymentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Successful', 'Failed'],
                datasets: [{
                    data: [
                        {{ analytics.payment_analytics.successful_payments }},
                        {{ analytics.payment_analytics.failed_payments }}
                    ],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Period selector
        function changePeriod(period) {
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.location.href = url.toString();
        }

        // Auto-refresh data every 10 minutes
        setTimeout(function() {
            location.reload();
        }, 10 * 60 * 1000);
    </script>
</body>
</html>