<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Connection Manager - Mind Mend Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-sidebar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
        }
        .admin-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .sidebar-nav {
            list-style: none;
            padding: 0;
        }
        .sidebar-nav li {
            margin-bottom: 0.5rem;
        }
        .sidebar-nav a {
            color: #bdc3c7;
            text-decoration: none;
            padding: 0.75rem 1rem;
            display: block;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background: #3498db;
            color: white;
        }
        .company-logo {
            text-align: center;
            padding: 2rem 1rem;
            border-bottom: 1px solid #34495e;
            margin-bottom: 2rem;
        }
        .match-item, .group-item, .challenge-item, .moderation-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }
        .action-btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        .moderation-queue .moderation-item {
            border-left-color: #e74c3c;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .create-form {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .tab-content {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .compatibility-score {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem;
            border-radius: 20px;
            text-align: center;
            font-weight: bold;
            width: 60px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 admin-sidebar">
                <div class="company-logo">
                    <h4><i class="fas fa-brain me-2"></i>Mind Mend</h4>
                    <small>Social Connection Manager</small>
                </div>

                <ul class="sidebar-nav">
                    <li><a href="{{ url_for('admin.dashboard') }}">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a></li>
                    <li><a href="{{ url_for('admin.enhancement_manager') }}">
                        <i class="fas fa-rocket me-2"></i>Enhancements
                    </a></li>
                    <li><a href="{{ url_for('admin.social_connection_manager') }}" class="active">
                        <i class="fas fa-users-line me-2"></i>Social Connections
                    </a></li>
                    <li><a href="{{ url_for('admin.user_management') }}">
                        <i class="fas fa-users me-2"></i>User Management
                    </a></li>
                </ul>

                <div class="mt-auto p-3">
                    <a href="{{ url_for('admin.logout') }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 admin-content">
                <div class="p-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-users-line me-2"></i>Social Connection Manager</h2>
                        <div>
                            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                                <i class="fas fa-plus me-1"></i>Create Group
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createChallengeModal">
                                <i class="fas fa-trophy me-1"></i>Create Challenge
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Overview -->
                    <div class="metrics-grid">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="total-matches">{{ stats.total_peer_matches }}</div>
                            <div class="text-muted">Peer Matches</div>
                            <small class="text-success"><i class="fas fa-arrow-up"></i> {{ stats.matches_this_week }} this week</small>
                        </div>
                        <div class="stat-card text-center">
                            <div class="stat-number" id="active-groups">{{ stats.active_group_sessions }}</div>
                            <div class="text-muted">Active Groups</div>
                            <small class="text-info"><i class="fas fa-users"></i> {{ stats.total_group_participants }} participants</small>
                        </div>
                        <div class="stat-card text-center">
                            <div class="stat-number" id="community-challenges">{{ stats.active_challenges }}</div>
                            <div class="text-muted">Community Challenges</div>
                            <small class="text-primary"><i class="fas fa-trophy"></i> {{ stats.challenge_participants }} participants</small>
                        </div>
                        <div class="stat-card text-center">
                            <div class="stat-number" id="moderation-queue">{{ stats.pending_moderation }}</div>
                            <div class="text-muted">Pending Moderation</div>
                            <small class="text-warning"><i class="fas fa-flag"></i> Requires attention</small>
                        </div>
                    </div>

                    <!-- Main Tabs -->
                    <ul class="nav nav-tabs mb-3" id="socialTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="peer-matches-tab" data-bs-toggle="tab" data-bs-target="#peer-matches" type="button" role="tab">
                                <i class="fas fa-handshake me-2"></i>Peer Matches
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="group-sessions-tab" data-bs-toggle="tab" data-bs-target="#group-sessions" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>Group Sessions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="challenges-tab" data-bs-toggle="tab" data-bs-target="#challenges" type="button" role="tab">
                                <i class="fas fa-trophy me-2"></i>Challenges
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="moderation-tab" data-bs-toggle="tab" data-bs-target="#moderation" type="button" role="tab">
                                <i class="fas fa-shield-alt me-2"></i>Moderation
                                {% if stats.pending_moderation > 0 %}
                                <span class="badge bg-danger ms-1">{{ stats.pending_moderation }}</span>
                                {% endif %}
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="socialTabsContent">
                        <!-- Peer Matches Tab -->
                        <div class="tab-pane fade show active" id="peer-matches" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-handshake me-2"></i>Recent Peer Matches</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="createTestMatch()">
                                    <i class="fas fa-flask me-1"></i>Create Test Match
                                </button>
                            </div>

                            <div id="peer-matches-list">
                                {% for match in recent_matches %}
                                <div class="match-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            <div class="compatibility-score">{{ match.compatibility_score }}%</div>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>{{ match.user1_name }} ↔ {{ match.user2_name }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                Shared interests: {{ match.shared_interests|join(', ') }}
                                                <br>Match reason: {{ match.match_reason }}
                                            </small>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="status-badge badge bg-{{ 'success' if match.status == 'active' else 'warning' if match.status == 'pending' else 'secondary' }}">
                                                {{ match.status|title }}
                                            </span>
                                        </div>
                                        <div class="col-md-2">
                                            {% if match.status == 'pending' %}
                                            <button class="btn btn-success action-btn me-1" onclick="moderateMatch('{{ match.match_id }}', 'approved')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-danger action-btn" onclick="moderateMatch('{{ match.match_id }}', 'rejected')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Group Sessions Tab -->
                        <div class="tab-pane fade" id="group-sessions" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-users me-2"></i>Active Group Sessions</h5>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                                    <i class="fas fa-plus me-1"></i>Create Session
                                </button>
                            </div>

                            <div id="group-sessions-list">
                                {% for session in active_groups %}
                                <div class="group-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong>{{ session.title }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                Type: {{ session.session_type|title }} |
                                                Participants: {{ session.current_participants }}/{{ session.max_participants }} |
                                                Scheduled: {{ session.scheduled_time.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                            <br>
                                            <span class="text-secondary">{{ session.description[:100] }}...</span>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="status-badge badge bg-{{ 'success' if session.status == 'active' else 'info' if session.status == 'scheduled' else 'warning' }}">
                                                {{ session.status|title }}
                                            </span>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-primary action-btn me-1" onclick="viewSession('{{ session.session_id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-danger action-btn" onclick="moderateSession('{{ session.session_id }}', 'suspended')">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Challenges Tab -->
                        <div class="tab-pane fade" id="challenges" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-trophy me-2"></i>Community Challenges</h5>
                                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createChallengeModal">
                                    <i class="fas fa-plus me-1"></i>Create Challenge
                                </button>
                            </div>

                            <div id="challenges-list">
                                {% for challenge in active_challenges %}
                                <div class="challenge-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong>{{ challenge.title }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                Type: {{ challenge.challenge_type|title }} |
                                                Participants: {{ challenge.participant_count }}/{{ challenge.max_participants }} |
                                                Duration: {{ challenge.duration_days }} days
                                            </small>
                                            <br>
                                            <span class="text-secondary">{{ challenge.description[:100] }}...</span>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="status-badge badge bg-{{ 'success' if challenge.status == 'active' else 'info' if challenge.status == 'upcoming' else 'secondary' }}">
                                                {{ challenge.status|title }}
                                            </span>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-primary action-btn me-1" onclick="viewChallenge('{{ challenge.challenge_id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary action-btn" onclick="updateChallenge('{{ challenge.challenge_id }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Moderation Tab -->
                        <div class="tab-pane fade" id="moderation" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-shield-alt me-2"></i>Content Moderation Queue</h5>
                                <span class="badge bg-warning">{{ content_queue|length }} items pending</span>
                            </div>

                            <div class="moderation-queue" id="moderation-queue">
                                {% for item in content_queue %}
                                <div class="moderation-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong>{{ item.content_type|title }} from {{ item.user_name }}</strong>
                                            <br>
                                            <div class="bg-light p-2 rounded mt-1">
                                                <span class="text-dark">{{ item.content[:200] }}...</span>
                                            </div>
                                            <small class="text-muted">
                                                Flagged for: {{ item.flag_reason }} |
                                                Reported: {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="status-badge badge bg-warning">Pending</span>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-success action-btn me-1" onclick="approveContent('{{ item.content_id }}')">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="btn btn-danger action-btn" onclick="rejectContent('{{ item.content_id }}')">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Session Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i>Create Group Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label for="sessionType" class="form-label">Session Type</label>
                            <select class="form-select" id="sessionType" required>
                                <option value="anxiety">Anxiety Support</option>
                                <option value="depression">Depression Support</option>
                                <option value="ptsd">PTSD Recovery</option>
                                <option value="addiction">Addiction Recovery</option>
                                <option value="general">General Wellness</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sessionTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="sessionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="sessionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="sessionDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="maxParticipants" class="form-label">Max Participants</label>
                            <input type="number" class="form-control" id="maxParticipants" min="2" max="12" value="8">
                        </div>
                        <div class="mb-3">
                            <label for="scheduledTime" class="form-label">Scheduled Time</label>
                            <input type="datetime-local" class="form-control" id="scheduledTime" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createGroupSession()">Create Session</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Challenge Modal -->
    <div class="modal fade" id="createChallengeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-trophy me-2"></i>Create Community Challenge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createChallengeForm">
                        <div class="mb-3">
                            <label for="challengeType" class="form-label">Challenge Type</label>
                            <select class="form-select" id="challengeType" required>
                                <option value="mindfulness">Mindfulness</option>
                                <option value="exercise">Exercise</option>
                                <option value="gratitude">Gratitude Practice</option>
                                <option value="social">Social Connection</option>
                                <option value="creativity">Creative Expression</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="challengeTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="challengeTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="challengeDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="challengeDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="durationDays" class="form-label">Duration (Days)</label>
                            <input type="number" class="form-control" id="durationDays" min="7" max="90" value="30">
                        </div>
                        <div class="mb-3">
                            <label for="maxChallengeParticipants" class="form-label">Max Participants</label>
                            <input type="number" class="form-control" id="maxChallengeParticipants" min="10" max="1000" value="100">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createChallenge()">Create Challenge</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh stats every 30 seconds
        setInterval(function() {
            fetch('/admin/api/social-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-matches').textContent = data.total_peer_matches;
                    document.getElementById('active-groups').textContent = data.active_group_sessions;
                    document.getElementById('community-challenges').textContent = data.active_challenges;
                    document.getElementById('moderation-queue').textContent = data.pending_moderation;
                })
                .catch(error => console.log('Stats update failed:', error));
        }, 30000);

        function createTestMatch() {
            fetch('/admin/api/peer-matches', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'create_test_match' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Test match created successfully!');
                    location.reload();
                } else {
                    alert('Failed to create test match');
                }
            });
        }

        function moderateMatch(matchId, status) {
            fetch('/admin/api/peer-matches', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'moderate_match',
                    match_id: matchId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Match ${status} successfully!`);
                    location.reload();
                } else {
                    alert('Failed to moderate match');
                }
            });
        }

        function createGroupSession() {
            const form = document.getElementById('createGroupForm');
            const formData = new FormData(form);

            fetch('/admin/api/group-sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'create_session',
                    session_type: document.getElementById('sessionType').value,
                    title: document.getElementById('sessionTitle').value,
                    description: document.getElementById('sessionDescription').value,
                    max_participants: parseInt(document.getElementById('maxParticipants').value),
                    scheduled_time: document.getElementById('scheduledTime').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Group session created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
                    location.reload();
                } else {
                    alert('Failed to create group session');
                }
            });
        }

        function createChallenge() {
            fetch('/admin/api/community-challenges', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'create_challenge',
                    challenge_type: document.getElementById('challengeType').value,
                    title: document.getElementById('challengeTitle').value,
                    description: document.getElementById('challengeDescription').value,
                    duration_days: parseInt(document.getElementById('durationDays').value),
                    max_participants: parseInt(document.getElementById('maxChallengeParticipants').value)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Challenge created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createChallengeModal')).hide();
                    location.reload();
                } else {
                    alert('Failed to create challenge');
                }
            });
        }

        function approveContent(contentId) {
            fetch('/admin/api/content-moderation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'approve',
                    content_id: contentId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Content approved!');
                    location.reload();
                } else {
                    alert('Failed to approve content');
                }
            });
        }

        function rejectContent(contentId) {
            const reason = prompt('Reason for rejection:');
            if (reason) {
                fetch('/admin/api/content-moderation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'reject',
                        content_id: contentId,
                        reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Content rejected!');
                        location.reload();
                    } else {
                        alert('Failed to reject content');
                    }
                });
            }
        }

        function viewSession(sessionId) {
            alert('Session details view - Feature coming soon');
        }

        function moderateSession(sessionId, status) {
            if (confirm(`Are you sure you want to ${status} this session?`)) {
                fetch('/admin/api/group-sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'moderate_session',
                        session_id: sessionId,
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Session ${status} successfully!`);
                        location.reload();
                    } else {
                        alert('Failed to moderate session');
                    }
                });
            }
        }

        function viewChallenge(challengeId) {
            alert('Challenge details view - Feature coming soon');
        }

        function updateChallenge(challengeId) {
            alert('Challenge update feature - Coming soon');
        }
    </script>
</body>
</html>