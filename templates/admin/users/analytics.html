<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Analytics - MindMend Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-positive { color: #28a745; }
        .trend-negative { color: #dc3545; }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .period-selector {
            background: white;
            border-radius: 10px;
            padding: 0.5rem;
            margin-bottom: 2rem;
        }
        .period-btn {
            border: none;
            background: transparent;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .period-btn.active {
            background: #667eea;
            color: white;
        }
        .insight-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        .risk-high { border-left-color: #dc3545; }
        .risk-medium { border-left-color: #ffc107; }
        .risk-low { border-left-color: #28a745; }
        .engagement-high { color: #28a745; }
        .engagement-medium { color: #ffc107; }
        .engagement-low { color: #dc3545; }
    </style>
</head>
<body>
    <div class="analytics-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>User Analytics Dashboard</h1>
                    <p class="mb-0">Comprehensive insights into user behavior and platform performance</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="period-selector">
                        <button class="period-btn {{ 'active' if period == '7d' else '' }}" onclick="changePeriod('7d')">7 Days</button>
                        <button class="period-btn {{ 'active' if period == '30d' else '' }}" onclick="changePeriod('30d')">30 Days</button>
                        <button class="period-btn {{ 'active' if period == '90d' else '' }}" onclick="changePeriod('90d')">90 Days</button>
                        <button class="period-btn {{ 'active' if period == '1y' else '' }}" onclick="changePeriod('1y')">1 Year</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Key Metrics Overview -->
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">{{ analytics.user_growth.total_users }}</div>
                    <div class="stat-label">Total Users</div>
                    <div class="mt-2">
                        <small class="trend-{{ 'positive' if analytics.user_growth.growth_rate > 0 else 'negative' }}">
                            <i class="fas fa-arrow-{{ 'up' if analytics.user_growth.growth_rate > 0 else 'down' }}"></i>
                            {{ analytics.user_growth.growth_rate }}% vs previous period
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">{{ analytics.engagement_analytics.active_users }}</div>
                    <div class="stat-label">Active Users</div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-users"></i>
                            {{ analytics.engagement_analytics.unique_session_users }} had sessions
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">{{ analytics.engagement_analytics.avg_engagement_score }}</div>
                    <div class="stat-label">Avg Engagement Score</div>
                    <div class="mt-2">
                        <small class="engagement-{{ 'high' if analytics.engagement_analytics.avg_engagement_score >= 70 else 'medium' if analytics.engagement_analytics.avg_engagement_score >= 40 else 'low' }}">
                            <i class="fas fa-chart-pie"></i>
                            {{ analytics.engagement_analytics.engagement_distribution.high }} high engagement users
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">${{ "{:,.0f}".format(analytics.subscription_analytics.monthly_revenue_potential) }}</div>
                    <div class="stat-label">Revenue Potential</div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-dollar-sign"></i>
                            {{ analytics.subscription_analytics.upgrade_candidates }} upgrade candidates
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-area me-2 text-primary"></i>User Growth Trend</h5>
                    <canvas id="growthChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie me-2 text-primary"></i>Subscription Distribution</h5>
                    <canvas id="subscriptionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5><i class="fas fa-heart-pulse me-2 text-primary"></i>Engagement Levels</h5>
                    <canvas id="engagementChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Risk Level Distribution</h5>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Behavioral Insights -->
        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5><i class="fas fa-clock me-2 text-primary"></i>Usage Patterns</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Peak Usage Day: {{ analytics.usage_patterns.peak_usage_day }}</h6>
                            <canvas id="usagePatternChart" height="150"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h6>Session Times Distribution</h6>
                            <canvas id="sessionTimesChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5><i class="fas fa-brain me-2 text-primary"></i>Behavioral Insights</h5>

                    <div class="insight-card">
                        <h6><i class="fas fa-smile me-2"></i>Mood Improvement</h6>
                        <p class="mb-1">Average: <strong>{{ analytics.behavioral_insights.avg_mood_improvement }}</strong> points</p>
                        <small class="text-muted">From {{ analytics.behavioral_insights.mood_improvement_sessions }} sessions</small>
                    </div>

                    <div class="insight-card risk-{{ 'high' if analytics.behavioral_insights.total_risk_users > 10 else 'medium' if analytics.behavioral_insights.total_risk_users > 5 else 'low' }}">
                        <h6><i class="fas fa-shield-alt me-2"></i>Users Requiring Attention</h6>
                        <p class="mb-1">High Risk: <strong>{{ analytics.behavioral_insights.high_risk_users }}</strong></p>
                        <p class="mb-1">Critical Risk: <strong>{{ analytics.behavioral_insights.critical_risk_users }}</strong></p>
                        <small class="text-muted">Monitor closely for crisis intervention</small>
                    </div>

                    <div class="insight-card">
                        <h6><i class="fas fa-redo me-2"></i>Retention Metrics</h6>
                        <p class="mb-1">7-day: <strong>{{ analytics.retention_metrics.seven_day_retention }}%</strong></p>
                        <p class="mb-1">Period: <strong>{{ analytics.retention_metrics.period_retention_rate }}%</strong></p>
                        <small class="text-muted">{{ analytics.retention_metrics.new_users_returned }}/{{ analytics.retention_metrics.total_new_users }} returned</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-tools me-2 text-primary"></i>Quick Actions</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.users_list', risk_level='high') }}" class="btn btn-outline-danger w-100">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                View High-Risk Users
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.users_list', subscription='free', status='active') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-arrow-up me-2"></i>
                                Upgrade Candidates
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.users_cohort_analysis') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-chart-bar me-2"></i>
                                Cohort Analysis
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin.users_export') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-download me-2"></i>
                                Export Data
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-5">
            <a href="{{ url_for('admin.users_list') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to User Management
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart.js configuration
        Chart.defaults.color = '#6c757d';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

        // Growth Chart
        const growthCtx = document.getElementById('growthChart').getContext('2d');
        fetch(`/admin/api/users/analytics/charts?type=growth&period={{ period }}`)
            .then(response => response.json())
            .then(data => {
                new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'New Users',
                            data: data.data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });

        // Subscription Chart
        const subscriptionCtx = document.getElementById('subscriptionChart').getContext('2d');
        const subscriptionData = {
            labels: {{ analytics.subscription_analytics.distribution.keys() | list | tojson }},
            datasets: [{
                data: {{ analytics.subscription_analytics.distribution.values() | list | tojson }},
                backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#667eea']
            }]
        };

        new Chart(subscriptionCtx, {
            type: 'doughnut',
            data: subscriptionData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Engagement Chart
        const engagementCtx = document.getElementById('engagementChart').getContext('2d');
        const engagementData = {
            labels: ['Low (0-39)', 'Medium (40-69)', 'High (70-100)'],
            datasets: [{
                data: [
                    {{ analytics.engagement_analytics.engagement_distribution.low }},
                    {{ analytics.engagement_analytics.engagement_distribution.medium }},
                    {{ analytics.engagement_analytics.engagement_distribution.high }}
                ],
                backgroundColor: ['#dc3545', '#ffc107', '#28a745']
            }]
        };

        new Chart(engagementCtx, {
            type: 'bar',
            data: engagementData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Risk Distribution Chart
        const riskCtx = document.getElementById('riskChart').getContext('2d');
        const riskData = {
            labels: {{ analytics.risk_analytics.distribution.keys() | list | tojson }},
            datasets: [{
                data: {{ analytics.risk_analytics.distribution.values() | list | tojson }},
                backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
            }]
        };

        new Chart(riskCtx, {
            type: 'doughnut',
            data: riskData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Usage Pattern Chart (Day of Week)
        const usagePatternCtx = document.getElementById('usagePatternChart').getContext('2d');
        const dowData = {{ analytics.usage_patterns.day_of_week | tojson }};
        new Chart(usagePatternCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(dowData),
                datasets: [{
                    data: Object.values(dowData),
                    backgroundColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Session Times Chart
        const sessionTimesCtx = document.getElementById('sessionTimesChart').getContext('2d');
        const sessionTimesData = {{ analytics.behavioral_insights.session_times | tojson }};
        new Chart(sessionTimesCtx, {
            type: 'line',
            data: {
                labels: sessionTimesData.map(item => item.hour + ':00'),
                datasets: [{
                    label: 'Sessions',
                    data: sessionTimesData.map(item => item.count),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Period selector
        function changePeriod(period) {
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.location.href = url.toString();
        }
    </script>
</body>
</html>