{% extends "base.html" %}

{% block title %}Join Mind Mend - Create Your Account{% endblock %}

{% block content %}
<div class="registration-container">
    <div class="registration-card">
        <!-- Logo and Header -->
        <div class="registration-header">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='logos/mindmend_logo_4.svg') }}" alt="Mind Mend" class="registration-logo">
                <h2>Join Mind Mend</h2>
                <p>Start your mental health journey with AI-powered therapy</p>
            </div>
        </div>

        <!-- Registration Form -->
        <div class="registration-form">
            <form id="registrationForm" method="POST" action="{{ url_for('register') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <!-- Step 1: Basic Information -->
                <div class="form-step active" data-step="1">
                    <h3>Basic Information</h3>
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                        <div class="form-hint">Your first name helps us personalize your experience</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required>
                        <div class="form-hint">We'll use this for secure login and important updates</div>
                    </div>
                </div>

                <!-- Step 2: Secure Login -->
                <div class="form-step" data-step="2">
                    <h3>Secure Login</h3>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required minlength="8">
                        <div class="password-requirements">
                            <div class="requirement" id="length">✓ At least 8 characters</div>
                            <div class="requirement" id="uppercase">✓ One uppercase letter</div>
                            <div class="requirement" id="lowercase">✓ One lowercase letter</div>
                            <div class="requirement" id="number">✓ One number</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                        <div class="form-hint" id="passwordMatch">Passwords must match</div>
                    </div>
                </div>

                <!-- Step 3: Personal Profile -->
                <div class="form-step" data-step="3">
                    <h3>Personal Profile</h3>
                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth</label>
                        <input type="date" id="dateOfBirth" name="dateOfBirth" required>
                        <div class="form-hint">Required to ensure age-appropriate care</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="gender">Gender (Optional)</label>
                        <select id="gender" name="gender">
                            <option value="">Prefer not to say</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="location">Location (Optional)</label>
                        <select id="location" name="location">
                            <option value="">Select your location</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="NZ">New Zealand</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="other">Other</option>
                        </select>
                        <div class="form-hint">Helps us provide relevant resources and crisis support</div>
                    </div>
                </div>

                <!-- Step 4: Mental Health Goals -->
                <div class="form-step" data-step="4">
                    <h3>Your Mental Health Goals</h3>
                    <div class="form-group">
                        <label>What brings you to Mind Mend? (Select all that apply)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="anxiety">
                                <span class="checkmark"></span>
                                Managing anxiety
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="depression">
                                <span class="checkmark"></span>
                                Dealing with depression
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="stress">
                                <span class="checkmark"></span>
                                Stress management
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="relationships">
                                <span class="checkmark"></span>
                                Relationship issues
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="self-esteem">
                                <span class="checkmark"></span>
                                Building self-esteem
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="trauma">
                                <span class="checkmark"></span>
                                Processing trauma
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="general">
                                <span class="checkmark"></span>
                                General mental wellness
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Privacy & Consent -->
                <div class="form-step" data-step="5">
                    <h3>Privacy & Consent</h3>
                    <div class="privacy-notice">
                        <h4>Your Privacy Matters</h4>
                        <p>Mind Mend is committed to protecting your privacy and maintaining the highest standards of data security.</p>
                        
                        <div class="privacy-highlights">
                            <div class="privacy-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>All data is encrypted and stored securely</span>
                            </div>
                            <div class="privacy-item">
                                <i class="fas fa-user-lock"></i>
                                <span>Your conversations remain private</span>
                            </div>
                            <div class="privacy-item">
                                <i class="fas fa-globe-americas"></i>
                                <span>Data stored securely with global compliance</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="consent-checkboxes">
                        <label class="checkbox-item required">
                            <input type="checkbox" name="termsAccepted" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a>
                        </label>
                        
                        <label class="checkbox-item required">
                            <input type="checkbox" name="ageConfirmed" required>
                            <span class="checkmark"></span>
                            I confirm that I am 18+ years old or have parental consent
                        </label>
                        
                        <label class="checkbox-item">
                            <input type="checkbox" name="marketingConsent">
                            <span class="checkmark"></span>
                            Send me helpful mental health tips and platform updates (optional)
                        </label>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="form-navigation">
                    <button type="button" id="prevBtn" onclick="previousStep()" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    
                    <div class="step-indicator">
                        <span class="step-dot active" data-step="1"></span>
                        <span class="step-dot" data-step="2"></span>
                        <span class="step-dot" data-step="3"></span>
                        <span class="step-dot" data-step="4"></span>
                        <span class="step-dot" data-step="5"></span>
                    </div>
                    
                    <button type="button" id="nextBtn" onclick="nextStep()">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Alternative Login -->
        <div class="alternative-login">
            <div class="divider">
                <span>Already have an account?</span>
            </div>
            <a href="{{ url_for('login') }}" class="login-link">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </a>
        </div>
    </div>

    <!-- Crisis Support Banner -->
    <div class="crisis-banner">
        <i class="fas fa-phone"></i>
        <span>Need immediate help? <strong>Crisis Text Line: Text HOME to 741741</strong></span>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.registration-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    position: relative;
}

.registration-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    max-width: 500px;
    width: 100%;
    overflow: hidden;
    animation: slideUp 0.6s ease;
}

.registration-header {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    padding: 2rem;
    text-align: center;
}

.registration-logo {
    height: 60px;
    margin-bottom: 1rem;
    filter: brightness(0) invert(1);
}

.registration-header h2 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    font-weight: 700;
}

.registration-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.registration-form {
    padding: 2rem;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
    animation: fadeInUp 0.4s ease;
}

.form-step h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
    text-align: center;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #333;
    font-weight: 600;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.form-hint {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

.password-requirements {
    margin-top: 0.5rem;
}

.requirement {
    font-size: 0.85rem;
    color: #999;
    margin-bottom: 0.25rem;
}

.requirement.valid {
    color: #4CAF50;
}

.requirement.invalid {
    color: #f44336;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.checkbox-item {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.3s ease;
}

.checkbox-item:hover {
    background: rgba(76, 175, 80, 0.05);
}

.checkbox-item input[type="checkbox"] {
    width: auto;
    margin-right: 0.75rem;
    transform: scale(1.2);
}

.checkbox-item.required {
    background: rgba(76, 175, 80, 0.02);
    border: 1px solid rgba(76, 175, 80, 0.2);
}

.privacy-notice {
    background: rgba(76, 175, 80, 0.05);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

.privacy-notice h4 {
    color: #333;
    margin-bottom: 0.5rem;
}

.privacy-notice p {
    color: #666;
    margin-bottom: 1rem;
}

.privacy-highlights {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.privacy-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #4CAF50;
    font-size: 0.9rem;
}

.consent-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.consent-checkboxes a {
    color: #4CAF50;
    text-decoration: underline;
}

.form-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e0e0e0;
}

.form-navigation button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-navigation button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
}

.form-navigation button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.step-indicator {
    display: flex;
    gap: 0.5rem;
}

.step-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #e0e0e0;
    transition: all 0.3s ease;
    cursor: pointer;
}

.step-dot.active {
    background: #4CAF50;
}

.step-dot.completed {
    background: #45a049;
}

.alternative-login {
    padding: 1.5rem 2rem;
    background: rgba(76, 175, 80, 0.05);
    text-align: center;
}

.divider {
    margin-bottom: 1rem;
    color: #666;
    font-size: 0.9rem;
}

.login-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #4CAF50;
    text-decoration: none;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    transition: all 0.3s ease;
}

.login-link:hover {
    background: rgba(76, 175, 80, 0.1);
    transform: translateY(-1px);
}

.crisis-banner {
    position: fixed;
    bottom: 1rem;
    left: 1rem;
    right: 1rem;
    background: #f44336;
    color: white;
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(244, 67, 54, 0.3);
    z-index: 1000;
}

.crisis-banner i {
    margin-right: 0.5rem;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .registration-container {
        padding: 1rem;
    }
    
    .registration-card {
        max-width: 100%;
    }
    
    .registration-form {
        padding: 1.5rem;
    }
    
    .form-navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .step-indicator {
        order: -1;
    }
    
    .crisis-banner {
        position: static;
        margin-top: 1rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
const totalSteps = 5;

function showStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show current step
    const currentStepElement = document.querySelector(`[data-step="${stepNumber}"]`);
    if (currentStepElement) {
        currentStepElement.classList.add('active');
    }
    
    // Update step indicators
    document.querySelectorAll('.step-dot').forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index + 1 === stepNumber) {
            dot.classList.add('active');
        } else if (index + 1 < stepNumber) {
            dot.classList.add('completed');
        }
    });
    
    // Update navigation buttons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    prevBtn.disabled = stepNumber === 1;
    
    if (stepNumber === totalSteps) {
        nextBtn.textContent = 'Create Account';
        nextBtn.innerHTML = 'Create Account <i class="fas fa-user-plus"></i>';
        nextBtn.onclick = submitForm;
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        nextBtn.onclick = nextStep;
    }
}

function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
            currentStep++;
            showStep(currentStep);
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

function validateCurrentStep() {
    const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
    const requiredFields = currentStepElement.querySelectorAll('input[required], select[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.style.borderColor = '#f44336';
            isValid = false;
        } else {
            field.style.borderColor = '#e0e0e0';
        }
    });
    
    // Special validation for step 2 (password)
    if (currentStep === 2) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            document.getElementById('confirmPassword').style.borderColor = '#f44336';
            document.getElementById('passwordMatch').style.color = '#f44336';
            document.getElementById('passwordMatch').textContent = 'Passwords do not match';
            isValid = false;
        } else {
            document.getElementById('confirmPassword').style.borderColor = '#4CAF50';
            document.getElementById('passwordMatch').style.color = '#4CAF50';
            document.getElementById('passwordMatch').textContent = 'Passwords match';
        }
    }
    
    // Special validation for step 5 (required checkboxes)
    if (currentStep === 5) {
        const requiredCheckboxes = currentStepElement.querySelectorAll('input[type="checkbox"][required]');
        requiredCheckboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.parentElement.style.borderColor = '#f44336';
                isValid = false;
            } else {
                checkbox.parentElement.style.borderColor = 'transparent';
            }
        });
    }
    
    return isValid;
}

function submitForm() {
    if (validateCurrentStep()) {
        document.getElementById('registrationForm').submit();
    }
}

// Password strength validation
document.getElementById('password').addEventListener('input', function() {
    const password = this.value;
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password)
    };
    
    Object.keys(requirements).forEach(req => {
        const element = document.getElementById(req);
        if (requirements[req]) {
            element.classList.add('valid');
            element.classList.remove('invalid');
        } else {
            element.classList.add('invalid');
            element.classList.remove('valid');
        }
    });
});

// Age validation
document.getElementById('dateOfBirth').addEventListener('change', function() {
    const birthDate = new Date(this.value);
    const today = new Date();
    const age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    if (age < 13) {
        this.style.borderColor = '#f44336';
        alert('Mind Mend is designed for users 13 and older. If you are under 18, please ensure you have parental consent.');
    } else {
        this.style.borderColor = '#4CAF50';
    }
});

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    showStep(1);
    
    // Add step dot click handlers
    document.querySelectorAll('.step-dot').forEach((dot, index) => {
        dot.addEventListener('click', function() {
            if (index + 1 <= currentStep || validateStepsUpTo(index + 1)) {
                currentStep = index + 1;
                showStep(currentStep);
            }
        });
    });
});

function validateStepsUpTo(stepNumber) {
    for (let i = 1; i < stepNumber; i++) {
        const stepElement = document.querySelector(`[data-step="${i}"]`);
        const requiredFields = stepElement.querySelectorAll('input[required], select[required]');
        
        for (let field of requiredFields) {
            if (!field.value.trim()) {
                return false;
            }
        }
    }
    return true;
}
</script>
{% endblock %}
