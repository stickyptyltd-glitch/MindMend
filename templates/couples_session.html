{% extends "base.html" %}

{% block title %}Couples Therapy Session - Mind Mend{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <!-- Main Chat Interface -->
            <div class="card chat-interface">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-heart me-2"></i>Couples Therapy Session
                        <span class="float-end">
                            <small>{{ partner1_name }} & {{ partner2_name }}</small>
                        </span>
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="chat-container" style="height: 400px; overflow-y: auto;">
                        <div class="chat-message ai">
                            <strong>AI Therapist:</strong> Welcome {{ partner1_name }} and {{ partner2_name }}! I'm here to facilitate a constructive conversation between you both. This is a safe space where you can express your feelings openly and honestly. Let's start with what brings you here today?
                        </div>
                    </div>

                    <!-- Partner Indicators -->
                    <div class="row mt-3 mb-2">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="currentSpeaker" id="partner1Radio" value="partner1" checked>
                                <label class="form-check-label" for="partner1Radio">
                                    <i class="fas fa-user me-1"></i>{{ partner1_name }} is typing
                                </label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="currentSpeaker" id="partner2Radio" value="partner2">
                                <label class="form-check-label" for="partner2Radio">
                                    <i class="fas fa-user me-1"></i>{{ partner2_name }} is typing
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Input Form -->
                    <form id="chatForm" class="mt-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i>Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Session Tools -->
            <div class="card mb-3">
                <div class="card-header bg-info">
                    <h5 class="mb-0 text-dark"><i class="fas fa-tools me-2"></i>Session Tools</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-info w-100 mb-2" onclick="requestExercise()">
                        <i class="fas fa-tasks me-2"></i>Request Exercise
                    </button>
                    <button class="btn btn-warning w-100 mb-2" onclick="pauseSession()">
                        <i class="fas fa-pause me-2"></i>Take a Break
                    </button>
                    <button class="btn btn-success w-100 mb-2" onclick="requestSummary()">
                        <i class="fas fa-clipboard-list me-2"></i>Get Summary
                    </button>
                    <button class="btn btn-danger w-100" onclick="endSession()">
                        <i class="fas fa-stop me-2"></i>End Session
                    </button>
                </div>
            </div>

            <!-- Relationship Health Indicators -->
            <div class="card mb-3">
                <div class="card-header bg-success">
                    <h5 class="mb-0 text-dark"><i class="fas fa-heartbeat me-2"></i>Relationship Health</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label>Communication Quality</label>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="communicationBar" role="progressbar" style="width: 70%;">70%</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Emotional Connection</label>
                        <div class="progress">
                            <div class="progress-bar bg-info" id="emotionalBar" role="progressbar" style="width: 60%;">60%</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Conflict Resolution</label>
                        <div class="progress">
                            <div class="progress-bar bg-warning" id="conflictBar" role="progressbar" style="width: 50%;">50%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tips & Guidelines -->
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0 text-dark"><i class="fas fa-lightbulb me-2"></i>Communication Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use "I feel" statements</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Listen without interrupting</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Acknowledge your partner's feelings</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Focus on solutions, not blame</li>
                        <li><i class="fas fa-check text-success me-2"></i>Take breaks if emotions run high</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Session variables
const partner1Name = "{{ partner1_name }}";
const partner2Name = "{{ partner2_name }}";
let currentSpeaker = 'partner1';

// Update current speaker
document.querySelectorAll('input[name="currentSpeaker"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        currentSpeaker = e.target.value;
    });
});

// Chat functionality
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Determine speaker name
    const speakerName = currentSpeaker === 'partner1' ? partner1Name : partner2Name;
    
    // Add message to chat
    addMessage(speakerName, message, 'user');
    
    // Clear input
    messageInput.value = '';
    
    // Send to AI
    try {
        const response = await fetch('/api/couples_session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                speaker: currentSpeaker,
                speaker_name: speakerName,
                partner1_name: partner1Name,
                partner2_name: partner2Name
            })
        });
        
        const data = await response.json();
        
        if (data.response) {
            addMessage('AI Therapist', data.response, 'ai');
            
            // Update relationship metrics if provided
            if (data.metrics) {
                updateMetrics(data.metrics);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        addMessage('System', 'Sorry, there was an error processing your message.', 'ai');
    }
});

function addMessage(speaker, message, type) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}`;
    
    if (type === 'user') {
        messageDiv.innerHTML = `<strong>${speaker}:</strong> ${message}`;
    } else {
        messageDiv.innerHTML = `<strong>${speaker}:</strong> ${message}`;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function updateMetrics(metrics) {
    if (metrics.communication !== undefined) {
        updateProgressBar('communicationBar', metrics.communication);
    }
    if (metrics.emotional !== undefined) {
        updateProgressBar('emotionalBar', metrics.emotional);
    }
    if (metrics.conflict !== undefined) {
        updateProgressBar('conflictBar', metrics.conflict);
    }
}

function updateProgressBar(barId, value) {
    const bar = document.getElementById(barId);
    bar.style.width = value + '%';
    bar.textContent = value + '%';
}

// Session tools
async function requestExercise() {
    try {
        const response = await fetch('/api/couples_exercise', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (data.exercise) {
            addMessage('AI Therapist', `Here's an exercise for you both: ${data.exercise}`, 'ai');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function pauseSession() {
    addMessage('AI Therapist', "Let's take a 5-minute break. Use this time to breathe and reflect on what we've discussed. When you're ready, we can continue.", 'ai');
}

async function requestSummary() {
    try {
        const response = await fetch('/api/couples_summary', {
            method: 'GET'
        });
        
        const data = await response.json();
        if (data.summary) {
            addMessage('AI Therapist', `Session Summary: ${data.summary}`, 'ai');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function endSession() {
    if (confirm('Are you sure you want to end this session?')) {
        window.location.href = '{{ url_for("couples_logout") }}';
    }
}
</script>
{% endblock %}