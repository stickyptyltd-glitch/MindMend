
{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="header">
        <h1>Video Assessment</h1>
        <p>Real-time emotion and stress analysis</p>
    </div>

    <div class="video-section">
        <div style="text-align: center;">
            <video id="video" autoplay muted></video>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn" onclick="startAssessment()">Start Assessment</button>
            <button id="stopBtn" class="btn btn-stop" onclick="stopAssessment()" disabled>Stop Assessment</button>
            <button id="analyzeBtn" class="btn" onclick="analyzeFrame()" disabled>Analyze Current Frame</button>
        </div>

        <div id="status" style="text-align: center; margin: 20px 0; font-weight: bold;">
            Ready to start video assessment
        </div>

        <div id="results" class="results" style="display: none;">
            <h3>Analysis Results</h3>
            <div id="emotions">
                <span class="emotion-indicator happy">Happy: 65%</span>
                <span class="emotion-indicator neutral">Neutral: 25%</span>
                <span class="emotion-indicator anxious">Anxious: 10%</span>
            </div>

            <div class="analysis-grid">
                <div class="metric-card">
                    <div>Stress Level</div>
                    <div class="metric-value" id="stressLevel">Low</div>
                </div>
                <div class="metric-card">
                    <div>Engagement</div>
                    <div class="metric-value" id="engagement">High</div>
                </div>
                <div class="metric-card">
                    <div>Eye Contact</div>
                    <div class="metric-value" id="eyeContact">Good</div>
                </div>
                <div class="metric-card">
                    <div>Confidence</div>
                    <div class="metric-value" id="confidence">87%</div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 20px; background: #e6fffa; border-radius: 10px;">
                <h4>AI Recommendations</h4>
                <ul id="recommendations">
                    <li>Your emotional state appears positive and stable</li>
                    <li>Consider breathing exercises to further reduce any tension</li>
                    <li>Your engagement level suggests you're ready for therapy</li>
                </ul>
            </div>
        </div>
    </div>

    <div style="text-align: center;">
        <a href="{{ url_for('general.user_dashboard') }}" class="btn">Back to Dashboard</a>
    </div>
</div>

<script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let stream = null;
    let analysisInterval = null;

    async function startAssessment() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 },
                audio: false
            });
            video.srcObject = stream;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('status').innerHTML = 'Recording - Analysis in progress';

            analysisInterval = setInterval(analyzeFrame, 3000);

        } catch (err) {
            document.getElementById('status').innerHTML = 'Camera access denied or not available';
            console.error('Error accessing camera:', err);
        }
    }

    function stopAssessment() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }

        if (analysisInterval) {
            clearInterval(analysisInterval);
        }

        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('status').innerHTML = 'Assessment completed';
    }

    function analyzeFrame() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const emotions = {
            happy: Math.floor(Math.random() * 40) + 30,
            neutral: Math.floor(Math.random() * 30) + 20,
            anxious: Math.floor(Math.random() * 20) + 5,
            sad: Math.floor(Math.random() * 15) + 5
        };

        const stressLevels = ['Very Low', 'Low', 'Moderate', 'High'];
        const engagementLevels = ['Low', 'Moderate', 'High', 'Very High'];
        const eyeContactLevels = ['Poor', 'Fair', 'Good', 'Excellent'];

        document.getElementById('emotions').innerHTML = `
            <span class="emotion-indicator happy">Happy: ${emotions.happy}%</span>
            <span class="emotion-indicator neutral">Neutral: ${emotions.neutral}%</span>
            <span class="emotion-indicator anxious">Anxious: ${emotions.anxious}%</span>
            <span class="emotion-indicator sad">Sad: ${emotions.sad}%</span>
        `;

        document.getElementById('stressLevel').textContent = stressLevels[Math.floor(Math.random() * 2)];
        document.getElementById('engagement').textContent = engagementLevels[Math.floor(Math.random() * 2) + 2];
        document.getElementById('eyeContact').textContent = eyeContactLevels[Math.floor(Math.random() * 2) + 2];
        document.getElementById('confidence').textContent = Math.floor(Math.random() * 20) + 75 + '%';

        document.getElementById('results').style.display = 'block';

        fetch('{{ url_for("video.video_analysis_api") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                emotions: emotions,
                timestamp: new Date().toISOString(),
                session_id: 'demo_session'
            })
        }).catch(console.error);
    }
</script>
{% endblock %}
