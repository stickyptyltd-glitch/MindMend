{% extends "base.html" %}

{% block title %}Individual Therapy - Mind Mend{% endblock %}

{% block head %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    .emotion-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.8em;
    }
    .biometric-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-normal { background-color: #28a745; }
    .status-elevated { background-color: #ffc107; }
    .status-high { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-user me-2"></i>Individual Therapy Session</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" id="toggleVideo" disabled>
                    <i class="fas fa-video me-1"></i>Enable Video
                </button>
                <button class="btn btn-outline-success" id="toggleBiometric" disabled>
                    <i class="fas fa-heartbeat me-1"></i>Connect Wearable
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Video and Emotion Analysis -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-video me-2"></i>Video Analysis</h5>
                <small class="text-muted">AI-powered emotion and microexpression detection</small>
            </div>
            <div class="card-body">
                <div class="video-container mb-3" style="height: 300px;">
                    <video id="videoElement" width="100%" height="100%" style="object-fit: cover;" muted></video>
                    <div class="emotion-overlay" id="emotionOverlay">
                        <div>Emotion: <span id="currentEmotion">Not detected</span></div>
                        <div>Confidence: <span id="emotionConfidence">0%</span></div>
                    </div>
                </div>
                
                <!-- Emotion Chart -->
                <canvas id="emotionChart" width="400" height="200"></canvas>
                
                <!-- Video Controls -->
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" id="startVideo">
                        <i class="fas fa-play me-1"></i>Start Video
                    </button>
                    <button class="btn btn-secondary btn-sm" id="stopVideo" disabled>
                        <i class="fas fa-stop me-1"></i>Stop Video
                    </button>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="enableMicroexpression">
                        <label class="form-check-label" for="enableMicroexpression">
                            Enable Microexpression Analysis
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Biometric Monitoring -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-heartbeat me-2"></i>Biometric Monitoring</h5>
                <small class="text-muted">Real-time health data integration</small>
            </div>
            <div class="card-body">
                <!-- Biometric Status -->
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="card bg-dark border-0">
                            <div class="card-body text-center py-2">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="biometric-indicator status-normal" id="hrStatus"></span>
                                    <div>
                                        <div class="h4 mb-0" id="heartRate">--</div>
                                        <small class="text-muted">Heart Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-dark border-0">
                            <div class="card-body text-center py-2">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="biometric-indicator status-normal" id="stressStatus"></span>
                                    <div>
                                        <div class="h4 mb-0" id="stressLevel">--</div>
                                        <small class="text-muted">Stress Level</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biometric Chart -->
                <canvas id="biometricChart" width="400" height="150"></canvas>

                <!-- Biometric Recommendations -->
                <div class="mt-3" id="biometricRecommendations">
                    <h6>Current Recommendations:</h6>
                    <ul class="list-unstyled" id="recommendationsList">
                        <li class="text-muted">Connect a wearable device to see recommendations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Therapy Session Interface -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments me-2"></i>Therapy Session</h5>
            </div>
            <div class="card-body">
                <form id="therapyForm">
                    <div class="mb-3">
                        <label for="patientName" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="patientName" required>
                    </div>

                    <div class="mb-3">
                        <label for="sessionInput" class="form-label">What would you like to discuss today?</label>
                        <textarea class="form-control" id="sessionInput" rows="4" 
                                placeholder="Share your thoughts, feelings, or concerns..." required></textarea>
                        <div class="form-text">
                            Your input will be analyzed with AI along with video and biometric data for comprehensive support.
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="moodBefore" class="form-label">Mood Before Session (1-10)</label>
                            <input type="range" class="form-range" id="moodBefore" min="1" max="10" value="5">
                            <div class="d-flex justify-content-between">
                                <small>Very Low</small>
                                <small id="moodBeforeValue">5</small>
                                <small>Very High</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="sessionGoal" class="form-label">Session Goal</label>
                            <select class="form-select" id="sessionGoal">
                                <option value="general">General Support</option>
                                <option value="anxiety">Anxiety Relief</option>
                                <option value="depression">Depression Support</option>
                                <option value="stress">Stress Management</option>
                                <option value="trauma">Trauma Processing</option>
                                <option value="relationships">Relationship Issues</option>
                                <option value="self_esteem">Self-Esteem</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>Start AI Analysis
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI Response and Analysis -->
<div class="row mt-4" id="responseSection" style="display: none;">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-robot me-2"></i>AI Therapist Analysis</h5>
            </div>
            <div class="card-body">
                <div id="aiResponse"></div>
                
                <!-- Multi-modal Analysis Results -->
                <div class="row g-3 mt-3" id="analysisResults">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Personalized Exercises -->
<div class="row mt-4" id="exercisesSection" style="display: none;">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-dumbbell me-2"></i>Personalized Exercises</h5>
            </div>
            <div class="card-body">
                <div id="exercisesList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Health Alerts -->
<div class="row mt-4" id="alertsSection" style="display: none;">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Health & Safety Alerts</h5>
            </div>
            <div class="card-body">
                <div id="healthAlerts"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Future integration points for external libraries -->
<!-- <script src="{{ url_for('static', filename='js/video-processing.js') }}"></script> -->
<!-- <script src="{{ url_for('static', filename='js/biometric-integration.js') }}"></script> -->
<!-- <script src="{{ url_for('static', filename='js/real-time-analysis.js') }}"></script> -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Video Analysis Integration
    const videoProcessor = {
        active: false,
        isActive() { return this.active; },
        async getCurrentFrame() { 
            // Placeholder for future video frame capture
            return null;
        },
        start() {
            this.active = true;
            console.log('Video analysis started');
        },
        stop() {
            this.active = false;
            console.log('Video analysis stopped');
        }
    };

    // Biometric Integration  
    const biometricIntegrator = {
        connected: false,
        isConnected() { return this.connected; },
        getCurrentData() {
            // Placeholder for future biometric data integration
            return null;
        },
        connect() {
            this.connected = true;
            console.log('Biometric devices connected');
        },
        disconnect() {
            this.connected = false;
            console.log('Biometric devices disconnected');
        }
    };

    // Mood slider
    const moodSlider = document.getElementById('moodBefore');
    const moodValue = document.getElementById('moodBeforeValue');
    moodSlider.addEventListener('input', function() {
        moodValue.textContent = this.value;
    });

    // Form submission
    const therapyForm = document.getElementById('therapyForm');
    therapyForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('patientName').value,
            input: document.getElementById('sessionInput').value,
            mood_before: document.getElementById('moodBefore').value,
            session_goal: document.getElementById('sessionGoal').value,
            session_type: 'individual'
        };

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
        submitBtn.disabled = true;

        try {
            // Start comprehensive analysis
            await processTherapySession(formData);
        } catch (error) {
            console.error('Therapy session error:', error);
            alert('An error occurred during analysis. Please try again.');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    async function processTherapySession(formData) {
        // Prepare therapy session data
        const sessionData = {
            message: formData.input,
            session_type: formData.session_type,
            patient_name: formData.name,
            mood_score: parseInt(formData.mood_before),
            context: {
                session_goal: formData.session_goal,
                video_enabled: videoProcessor.isActive(),
                biometric_enabled: biometricIntegrator.isConnected()
            }
        };

        // Get current video frame if available
        if (videoProcessor.isActive()) {
            sessionData.context.current_frame = await videoProcessor.getCurrentFrame();
        }

        // Get current biometric data if available
        if (biometricIntegrator.isConnected()) {
            sessionData.context.biometric_data = biometricIntegrator.getCurrentData();
        }

        // Send to therapy session endpoint
        const response = await fetch('/api/therapy-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(sessionData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        displayAnalysisResults(result, formData);
    }

    function displayAnalysisResults(result, formData) {
        // Check if request was successful
        if (!result.success) {
            document.getElementById('aiResponse').innerHTML = `
                <div class="alert alert-danger">
                    <h6>Error:</h6>
                    <p>${result.error || 'An error occurred during the session.'}</p>
                    ${result.fallback_response ? `<hr><p><strong>Fallback Response:</strong> ${result.fallback_response}</p>` : ''}
                </div>
            `;
            return;
        }

        // Display AI therapist response
        document.getElementById('aiResponse').innerHTML = `
            <div class="alert alert-info">
                <h6><i class="fas fa-robot me-2"></i>AI Therapist Response:</h6>
                <p>${result.response}</p>
                ${result.session_id ? `<small class="text-muted">Session ID: ${result.session_id}</small>` : ''}
            </div>
        `;

        // Display multi-modal analysis
        const analysisResults = document.getElementById('analysisResults');
        let analysisHtml = '';

        // Mood Analysis
        if (result.mood_analysis) {
            const mood = result.mood_analysis.mood || 'neutral';
            const intensity = result.mood_analysis.intensity || 5;
            const moodColor = mood === 'positive' ? 'success' : mood === 'negative' ? 'warning' : 'info';
            
            analysisHtml += `
                <div class="col-md-4">
                    <div class="card bg-dark border-0">
                        <div class="card-body text-center">
                            <i class="fas fa-heart fa-2x text-${moodColor} mb-2"></i>
                            <h6>Mood Analysis</h6>
                            <p class="mb-0 text-${moodColor}">${mood.charAt(0).toUpperCase() + mood.slice(1)}</p>
                            <small class="text-muted">Intensity: ${intensity}/10</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // Crisis Risk Level
        const riskColor = result.crisis_level === 'high' ? 'danger' : 
                        result.crisis_level === 'medium' ? 'warning' : 'success';
        analysisHtml += `
            <div class="col-md-4">
                <div class="card bg-dark border-0">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-${riskColor} mb-2"></i>
                        <h6>Crisis Level</h6>
                        <p class="mb-0 text-${riskColor}">${result.crisis_level || 'Low'}</p>
                        <small class="text-muted">Assessment: Complete</small>
                    </div>
                </div>
            `;
        }

        // Recommendations
        if (result.recommendations && result.recommendations.length > 0) {
            analysisHtml += `
                <div class="col-md-4">
                    <div class="card bg-dark border-0">
                        <div class="card-body text-center">
                            <i class="fas fa-lightbulb fa-2x text-warning mb-2"></i>
                            <h6>Recommendations</h6>
                            <p class="mb-0">${result.recommendations[0] || 'Continue current approach'}</p>
                            <small class="text-muted">${result.recommendations.length} total suggestions</small>
                        </div>
                    </div>
                </div>
            `;
        }

        analysisResults.innerHTML = analysisHtml;

        // Display recommendations as exercises
        if (result.recommendations && result.recommendations.length > 0) {
            displayRecommendations(result.recommendations);
        }

        // Display next steps
        if (result.next_steps && result.next_steps.length > 0) {
            displayNextSteps(result.next_steps);
        }

        // Show all sections
        document.getElementById('responseSection').style.display = 'block';
        if (result.recommendations && result.recommendations.length > 0) {
            document.getElementById('exercisesSection').style.display = 'block';
        }
        
        // Show crisis alerts if high risk
        if (result.crisis_level === 'high' || result.crisis_level === 'critical') {
            displayCrisisAlert(result.crisis_level);
        }
    }

    function displayRecommendations(recommendations) {
        const exercisesList = document.getElementById('exercisesList');
        let exercisesHtml = '<h6 class="mb-3"><i class="fas fa-lightbulb me-2"></i>Therapeutic Recommendations</h6>';

        recommendations.forEach((recommendation, index) => {
            exercisesHtml += `
                <div class="card mb-3 bg-dark border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-warning text-dark">${index + 1}</span>
                            </div>
                            <div class="flex-grow-1">
                                <p class="mb-0">${recommendation}</p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-warning" onclick="markCompleted(${index})">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        exercisesList.innerHTML = exercisesHtml;
    }

    function displayNextSteps(nextSteps) {
        // Add next steps to exercises section if it exists
        const exercisesList = document.getElementById('exercisesList');
        if (exercisesList && nextSteps.length > 0) {
            let nextStepsHtml = '<h6 class="mt-4 mb-3"><i class="fas fa-arrow-right me-2"></i>Next Steps</h6>';
            
            nextSteps.forEach((step, index) => {
                nextStepsHtml += `
                    <div class="card mb-2 bg-dark border-info">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-step-forward text-info"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <small>${step}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            exercisesList.innerHTML += nextStepsHtml;
        }
    }

    function displayCrisisAlert(crisisLevel) {
        const alertsSection = document.getElementById('alertsSection');
        if (alertsSection) {
            const alertColor = crisisLevel === 'critical' ? 'danger' : 'warning';
            document.getElementById('healthAlerts').innerHTML = `
                <div class="alert alert-${alertColor}">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Crisis Alert</h6>
                    <p><strong>${crisisLevel.toUpperCase()} risk level detected.</strong></p>
                    <p>Please consider reaching out for immediate support:</p>
                    <ul>
                        <li>National Suicide Prevention Lifeline: <strong>988</strong></li>
                        <li>Crisis Text Line: <strong>Text HOME to 741741</strong></li>
                        <li>Emergency Services: <strong>911</strong></li>
                    </ul>
                </div>
            `;
            alertsSection.style.display = 'block';
        }
    }

    function markCompleted(index) {
        event.target.innerHTML = '<i class="fas fa-check-circle"></i>';
        event.target.className = 'btn btn-sm btn-success';
        event.target.disabled = true;
                            <strong>Instructions:</strong>
                            <ol class="mt-2">
                                ${exercise.instructions.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Benefits:</strong> ${exercise.benefits ? exercise.benefits.join(', ') : 'General wellness'}
                            </div>
                            <button class="btn btn-success btn-sm" onclick="startExercise(${index})">
                                <i class="fas fa-play me-1"></i>Start Exercise
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        exercisesList.innerHTML = exercisesHtml;
    }

    function displayHealthAlerts(alerts) {
        const healthAlerts = document.getElementById('healthAlerts');
        let alertsHtml = '';

        alerts.forEach(alert => {
            const alertClass = alert.severity === 'critical' ? 'danger' : 
                             alert.severity === 'high' ? 'warning' : 'info';
            alertsHtml += `
                <div class="alert alert-${alertClass}">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>${alert.message}</h6>
                    ${alert.action ? `<p class="mb-2"><strong>Recommended Action:</strong> ${alert.action}</p>` : ''}
                    ${alert.resources ? `
                        <div class="mt-2">
                            <strong>Resources:</strong>
                            <ul class="mb-0">
                                ${alert.resources.map(resource => `
                                    <li>${resource.name}: ${resource.contact}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        healthAlerts.innerHTML = alertsHtml;
    }

    // Global function for exercise interaction
    window.startExercise = function(index) {
        // Implementation for starting guided exercises
        console.log('Starting exercise:', index);
        // This would integrate with a guided exercise system
    };
});
</script>
{% endblock %}
