{% extends "base.html" %}

{% block title %}AI Video Assessment - Mind Mend{% endblock %}

{% block head %}
<style>
    .video-assessment-container {
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }
    
    /* Mobile-friendly camera view */
    .camera-container {
        position: relative;
        width: 100%;
        height: 400px;
        transition: all 0.3s ease;
    }
    
    .camera-container.minimized {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 200px;
        height: 150px;
        z-index: 1000;
        border: 2px solid #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .video-element {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }
    
    .camera-controls {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
    }
    
    .camera-controls.minimized {
        bottom: 5px;
        gap: 5px;
    }
    
    .camera-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 20px;
        background: rgba(255,255,255,0.9);
        color: #333;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .camera-btn.minimized {
        padding: 4px 8px;
        font-size: 10px;
    }
    
    .camera-btn:hover {
        background: rgba(255,255,255,1);
        transform: scale(1.05);
    }
    
    /* Questions panel - always visible on mobile */
    .questions-panel {
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        min-height: 300px;
    }
    
    .questions-panel.camera-active {
        margin-top: 0;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
        .camera-container {
            height: 300px;
        }
        
        .camera-container.minimized {
            width: 150px;
            height: 100px;
            top: 10px;
            right: 10px;
        }
        
        .questions-panel {
            padding: 15px;
            margin-bottom: 120px; /* Space for minimized camera */
        }
        
        .questions-panel.camera-active {
            padding-top: 60px; /* Space for minimized camera when active */
        }
    }
    
    .assessment-overlay {
        position: absolute;
        top: 0;
        right: 0;
        background: linear-gradient(45deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
        color: white;
        padding: 15px;
        border-radius: 0 12px 0 12px;
        min-width: 200px;
    }
    .emotion-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .confidence-bar {
        height: 6px;
        background: rgba(255,255,255,0.3);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 4px;
    }
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
        transition: width 0.3s ease;
    }
    .microexpression-alert {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(255, 193, 7, 0.9);
        color: #000;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9em;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    .microexpression-alert.show {
        transform: translateY(0);
        opacity: 1;
    }
    .assessment-phase {
        border-left: 4px solid var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.1);
    }
    .assessment-complete {
        border-left: 4px solid var(--bs-success);
        background: rgba(var(--bs-success-rgb), 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-video me-2"></i>AI Video Assessment</h2>
            <div class="d-flex gap-2">
                <span class="badge bg-info" id="assessmentStatus">Ready to Start</span>
                <button class="btn btn-outline-primary" id="settingsBtn">
                    <i class="fas fa-cog me-1"></i>Settings
                </button>
            </div>
        </div>
        <p class="text-muted">Comprehensive AI-powered video interview with emotion analysis, microexpression detection, and therapeutic assessment.</p>
        
        <!-- Camera Permission Notice -->
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Camera Access Required:</strong> This assessment requires camera access for facial analysis. 
            If you haven't granted permissions, click "Start Assessment" and allow camera access when prompted. 
            Alternatively, use "Test Mode" to explore the assessment without camera.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Video Assessment Interface -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body p-0">
                <div class="camera-container" id="cameraContainer">
                    <div class="video-assessment-container" style="height: 450px;">
                        <video id="assessmentVideo" width="100%" height="100%" style="object-fit: cover;" muted class="video-element"></video>
                        
                        <!-- Camera Controls Overlay -->
                        <div class="camera-controls" id="cameraControls">
                            <button class="camera-btn" id="minimizeBtn" onclick="toggleCameraSize()">
                                <i class="fas fa-compress"></i> Minimize
                            </button>
                            <button class="camera-btn" id="maximizeBtn" onclick="toggleCameraSize()" style="display: none;">
                                <i class="fas fa-expand"></i> Expand
                            </button>
                        </div>
                    
                    <!-- Real-time Analysis Overlay -->
                    <div class="assessment-overlay" id="analysisOverlay">
                        <div class="mb-2">
                            <strong>Primary Emotion</strong>
                            <div class="d-flex align-items-center mt-1">
                                <span class="emotion-indicator bg-primary" id="emotionIndicator"></span>
                                <span id="primaryEmotion">Neutral</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="emotionConfidence" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <strong>Stress Level</strong>
                            <div class="mt-1">
                                <span id="stressLevel">Low</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" id="stressConfidence" style="width: 25%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <strong>Engagement</strong>
                            <div class="mt-1">
                                <span id="engagementLevel">High</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" id="engagementConfidence" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <strong>Eye Contact</strong>
                            <div class="mt-1">
                                <span id="eyeContact">Good</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Microexpression Alert -->
                    <div class="microexpression-alert" id="microAlert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="microText">Subtle emotional shift detected</span>
                    </div>
                </div>
                
                <!-- Video Controls -->
                <div class="p-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" id="startAssessment">
                                <i class="fas fa-play me-1"></i>Start Assessment
                            </button>
                            <button class="btn btn-danger" id="stopAssessment" disabled>
                                <i class="fas fa-stop me-1"></i>Stop
                            </button>
                            <button class="btn btn-warning" id="pauseAssessment" disabled>
                                <i class="fas fa-pause me-1"></i>Pause
                            </button>
                            <button class="btn btn-secondary" id="testMode">
                                <i class="fas fa-flask me-1"></i>Test Mode
                            </button>
                        </div>
                        
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableMicroexpression" checked>
                                <label class="form-check-label" for="enableMicroexpression">
                                    Microexpression Analysis
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableVoiceAnalysis" checked>
                                <label class="form-check-label" for="enableVoiceAnalysis">
                                    Voice Analysis
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h6><i class="fas fa-list-check me-2"></i>Assessment Progress</h6>
            </div>
            <div class="card-body">
                <div id="assessmentPhases">
                    <div class="assessment-phase p-3 rounded mb-3" id="phase1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">1. Initial Calibration</h6>
                                <small class="text-muted">Establishing baseline</small>
                            </div>
                            <i class="fas fa-clock text-muted"></i>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: 0%" id="phase1Progress"></div>
                        </div>
                    </div>
                    
                    <div class="assessment-phase p-3 rounded mb-3" id="phase2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">2. Mood Assessment</h6>
                                <small class="text-muted">Current emotional state</small>
                            </div>
                            <i class="fas fa-clock text-muted"></i>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: 0%" id="phase2Progress"></div>
                        </div>
                    </div>
                    
                    <div class="assessment-phase p-3 rounded mb-3" id="phase3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">3. Stress Response</h6>
                                <small class="text-muted">Anxiety and stress indicators</small>
                            </div>
                            <i class="fas fa-clock text-muted"></i>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: 0%" id="phase3Progress"></div>
                        </div>
                    </div>
                    
                    <div class="assessment-phase p-3 rounded mb-3" id="phase4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">4. Communication Patterns</h6>
                                <small class="text-muted">Voice and expression analysis</small>
                            </div>
                            <i class="fas fa-clock text-muted"></i>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: 0%" id="phase4Progress"></div>
                        </div>
                    </div>
                    
                    <div class="assessment-phase p-3 rounded" id="phase5">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">5. Comprehensive Analysis</h6>
                                <small class="text-muted">Generating recommendations</small>
                            </div>
                            <i class="fas fa-clock text-muted"></i>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: 0%" id="phase5Progress"></div>
                        </div>
                    </div>
                </div>
                
                <div id="currentInstructions" class="mt-4">
                    <h6>Instructions</h6>
                    <p class="text-muted" id="instructionText">Position yourself comfortably in front of the camera and click "Start Assessment" when ready.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Questions Panel for Mobile -->
<div class="questions-panel" id="questionsPanel" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-question-circle me-2"></i>Assessment Questions</h5>
            <small class="text-muted">Answer while the camera is recording</small>
        </div>
        <div class="card-body">
            <div id="currentQuestion">
                <h6>Question 1 of 5</h6>
                <p class="mb-3">How have you been feeling emotionally over the past week?</p>
                <div class="form-group mb-3">
                    <textarea class="form-control" rows="3" placeholder="Type your response here..." id="questionResponse"></textarea>
                </div>
                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" id="prevQuestion" disabled>Previous</button>
                    <button class="btn btn-primary" id="nextQuestion">Next Question</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assessment Complete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assessmentResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="scheduleSession">Schedule Follow-up Session</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Mobile detection and camera management
let isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let cameraMinimized = false;
let assessmentActive = false;
let currentQuestionIndex = 0;

const questions = [
    "How have you been feeling emotionally over the past week?",
    "What situations or events tend to make you feel stressed or anxious?", 
    "How would you describe your energy levels and motivation recently?",
    "What coping strategies do you currently use when facing challenges?",
    "What are your main goals for improving your mental well-being?"
];

// Auto-minimize camera on mobile when assessment starts
function autoMinimizeOnMobile() {
    if (isMobile && assessmentActive && !cameraMinimized) {
        setTimeout(() => {
            toggleCameraSize();
            showQuestionsPanel();
        }, 3000); // Auto-minimize after 3 seconds on mobile
    }
}

function toggleCameraSize() {
    const container = document.getElementById('cameraContainer');
    const controls = document.getElementById('cameraControls');
    const minimizeBtn = document.getElementById('minimizeBtn');
    const maximizeBtn = document.getElementById('maximizeBtn');
    
    if (cameraMinimized) {
        // Expand camera
        container.classList.remove('minimized');
        controls.classList.remove('minimized');
        minimizeBtn.style.display = 'block';
        maximizeBtn.style.display = 'none';
        cameraMinimized = false;
        hideQuestionsPanel();
    } else {
        // Minimize camera
        container.classList.add('minimized');
        controls.classList.add('minimized');
        minimizeBtn.style.display = 'none';
        maximizeBtn.style.display = 'block';
        cameraMinimized = true;
        if (assessmentActive) {
            showQuestionsPanel();
        }
    }
}

function showQuestionsPanel() {
    const panel = document.getElementById('questionsPanel');
    panel.style.display = 'block';
    panel.classList.add('camera-active');
    updateQuestion();
}

function hideQuestionsPanel() {
    const panel = document.getElementById('questionsPanel');
    panel.style.display = 'none';
    panel.classList.remove('camera-active');
}

function updateQuestion() {
    const questionDiv = document.getElementById('currentQuestion');
    const questionText = questions[currentQuestionIndex];
    const questionNumber = currentQuestionIndex + 1;
    
    questionDiv.innerHTML = `
        <h6>Question ${questionNumber} of ${questions.length}</h6>
        <p class="mb-3">${questionText}</p>
        <div class="form-group mb-3">
            <textarea class="form-control" rows="3" placeholder="Type your response here..." id="questionResponse"></textarea>
        </div>
        <div class="d-flex justify-content-between">
            <button class="btn btn-outline-secondary" id="prevQuestion" ${currentQuestionIndex === 0 ? 'disabled' : ''}>Previous</button>
            <button class="btn btn-primary" id="nextQuestion">${currentQuestionIndex === questions.length - 1 ? 'Complete Assessment' : 'Next Question'}</button>
        </div>
    `;
    
    // Re-attach event listeners
    document.getElementById('prevQuestion').onclick = previousQuestion;
    document.getElementById('nextQuestion').onclick = nextQuestion;
}

function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        updateQuestion();
    } else {
        // Complete assessment
        completeAssessment();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        updateQuestion();
    }
}

function completeAssessment() {
    assessmentActive = false;
    hideQuestionsPanel();
    
    // Show results modal
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    document.getElementById('assessmentResults').innerHTML = `
        <div class="text-center mb-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h4>Assessment Complete!</h4>
            <p class="text-muted">Your video assessment has been processed and analyzed.</p>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h6>Key Findings:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-circle text-success me-2"></i>Overall mood: Stable</li>
                    <li><i class="fas fa-circle text-warning me-2"></i>Stress indicators: Moderate</li>
                    <li><i class="fas fa-circle text-info me-2"></i>Engagement level: High</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Recommendations:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-lightbulb text-warning me-2"></i>Consider mindfulness exercises</li>
                    <li><i class="fas fa-lightbulb text-warning me-2"></i>Regular therapy sessions recommended</li>
                    <li><i class="fas fa-lightbulb text-warning me-2"></i>Stress management techniques</li>
                </ul>
            </div>
        </div>
    `;
    modal.show();
}

// Camera and assessment controls
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startAssessment');
    const stopBtn = document.getElementById('stopAssessment');
    const pauseBtn = document.getElementById('pauseAssessment');
    
    startBtn.addEventListener('click', async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }, 
                audio: true 
            });
            
            document.getElementById('assessmentVideo').srcObject = stream;
            assessmentActive = true;
            
            // Auto-minimize on mobile after starting
            autoMinimizeOnMobile();
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            pauseBtn.disabled = false;
            
            document.getElementById('assessmentStatus').textContent = 'Recording';
            document.getElementById('assessmentStatus').className = 'badge bg-danger';
            
        } catch (error) {
            console.error('Camera access error:', error);
            alert('Unable to access camera. Please ensure camera permissions are granted.');
        }
    });
    
    stopBtn.addEventListener('click', function() {
        const video = document.getElementById('assessmentVideo');
        const stream = video.srcObject;
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        
        assessmentActive = false;
        hideQuestionsPanel();
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        pauseBtn.disabled = true;
        
        document.getElementById('assessmentStatus').textContent = 'Stopped';
        document.getElementById('assessmentStatus').className = 'badge bg-secondary';
    });
    
    // Handle window resize for mobile detection
    window.addEventListener('resize', function() {
        isMobile = window.innerWidth <= 768;
        if (!isMobile && cameraMinimized) {
            toggleCameraSize(); // Auto-expand on desktop
        }
    });
});
</script>
                    <p class="text-muted" id="instructionText">
                        Click "Start Assessment" to begin. Make sure you're in a well-lit area and looking directly at the camera.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Questions -->
<div class="row mt-4" id="questionSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-question-circle me-2"></i>Assessment Questions</h5>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar" id="questionProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="card-body">
                <div id="currentQuestion">
                    <!-- Questions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Results -->
<div class="row mt-4" id="resultsSection" style="display: none;">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-chart-line me-2"></i>Assessment Results</h5>
            </div>
            <div class="card-body">
                <div id="assessmentResults">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Assessment Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label for="assessmentDuration" class="form-label">Assessment Duration</label>
                        <select class="form-select" id="assessmentDuration">
                            <option value="5">5 minutes (Quick)</option>
                            <option value="10" selected>10 minutes (Standard)</option>
                            <option value="15">15 minutes (Comprehensive)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="analysisDepth" class="form-label">Analysis Depth</label>
                        <select class="form-select" id="analysisDepth">
                            <option value="basic">Basic Emotions</option>
                            <option value="standard" selected>Standard Analysis</option>
                            <option value="advanced">Advanced + Microexpressions</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="saveRecording">
                            <label class="form-check-label" for="saveRecording">
                                Save recording for later review
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareWithTherapist">
                            <label class="form-check-label" for="shareWithTherapist">
                                Share results with assigned therapist
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettings">Save Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/video-processing.js') }}"></script>
<script src="{{ url_for('static', filename='js/real-time-analysis.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let assessmentActive = false;
    let currentPhase = 0;
    let currentQuestionIndex = 0;
    let assessmentData = {};
    
    // Assessment questions for different phases
    const assessmentQuestions = [
        {
            phase: 2,
            question: "How are you feeling right now, on a scale of 1 to 10?",
            type: "scale",
            instruction: "Please answer naturally while looking at the camera."
        },
        {
            phase: 2,
            question: "Can you describe what's been on your mind lately?",
            type: "open",
            instruction: "Take your time to respond. Your facial expressions and voice will be analyzed."
        },
        {
            phase: 3,
            question: "Think about a recent stressful situation. How did it make you feel?",
            type: "open",
            instruction: "Notice any changes in how you feel as you recall this memory."
        },
        {
            phase: 4,
            question: "Tell me about something that makes you happy.",
            type: "open",
            instruction: "Let your natural emotions show as you speak."
        },
        {
            phase: 4,
            question: "How comfortable do you feel talking about your emotions?",
            type: "scale",
            instruction: "Your response pattern will help calibrate our analysis."
        }
    ];
    
    // Initialize video processing
    const videoProcessor = new VideoProcessor();
    const realTimeAnalyzer = new RealTimeAnalyzer();
    
    // Event listeners
    document.getElementById('startAssessment').addEventListener('click', startAssessment);
    document.getElementById('stopAssessment').addEventListener('click', stopAssessment);
    document.getElementById('pauseAssessment').addEventListener('click', pauseAssessment);
    document.getElementById('settingsBtn').addEventListener('click', showSettings);
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    document.getElementById('testMode').addEventListener('click', startTestMode);
    
    // Test Mode functionality
    async function startTestMode() {
        // Check camera permissions first
        try {
            const permissionStatus = await navigator.permissions.query({ name: 'camera' });
            
            if (permissionStatus.state === 'granted') {
                alert('Camera permissions are already granted. You can use the regular assessment mode.');
                return;
            }
            
            if (permissionStatus.state === 'prompt') {
                alert('Camera permissions have not been set. Click "Start Assessment" to request camera access, or continue with test mode without camera.');
            } else {
                alert('Camera permissions are denied. You can still use test mode to see how the assessment works without camera access.');
            }
        } catch (e) {
            // Permissions API not supported
            alert('Test mode allows you to experience the assessment without camera access. For full functionality, use "Start Assessment" instead.');
        }
        
        // Start test mode without camera
        startAssessmentWithoutCamera();
    }
    
    async function startAssessmentWithoutCamera() {
        assessmentActive = true;
        currentPhase = 1;
        
        // Create a mock video element with test pattern
        const videoElement = document.getElementById('assessmentVideo');
        const canvas = document.createElement('canvas');
        canvas.width = 640;
        canvas.height = 480;
        const ctx = canvas.getContext('2d');
        
        // Draw test pattern
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ffffff';
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Test Mode - No Camera', canvas.width/2, canvas.height/2);
        
        // Convert to video stream
        const stream = canvas.captureStream(30);
        videoElement.srcObject = stream;
        
        // Update UI
        document.getElementById('startAssessment').disabled = true;
        document.getElementById('stopAssessment').disabled = false;
        document.getElementById('pauseAssessment').disabled = false;
        document.getElementById('assessmentStatus').textContent = 'Test Mode Active';
        document.getElementById('assessmentStatus').className = 'badge bg-info';
        
        // Run assessment phases
        runAssessmentPhases();
        
        // Use mock data for real-time analysis
        startMockRealTimeAnalysis();
    }
    
    async function startAssessment() {
        try {
            // Start video capture
            const videoElement = document.getElementById('assessmentVideo');
            await videoProcessor.startCapture(videoElement);
            
            assessmentActive = true;
            currentPhase = 1;
            
            // Update UI
            document.getElementById('startAssessment').disabled = true;
            document.getElementById('stopAssessment').disabled = false;
            document.getElementById('pauseAssessment').disabled = false;
            document.getElementById('assessmentStatus').textContent = 'Assessment Active';
            document.getElementById('assessmentStatus').className = 'badge bg-success';
            
            // Start assessment phases
            runAssessmentPhases();
            
            // Start real-time analysis
            startRealTimeAnalysis();
            
        } catch (error) {
            console.error('Error starting assessment:', error);
            
            // More detailed error handling
            let errorMessage = 'Unable to access camera. ';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMessage += 'Please grant camera permissions and refresh the page.';
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                errorMessage += 'No camera device found. Please connect a camera.';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                errorMessage += 'Camera is being used by another application.';
            } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                errorMessage += 'Camera settings are not supported.';
            } else {
                errorMessage += error.message || 'Please check your browser settings.';
            }
            
            alert(errorMessage);
            
            // Reset UI
            document.getElementById('startAssessment').disabled = false;
            document.getElementById('stopAssessment').disabled = true;
            document.getElementById('pauseAssessment').disabled = true;
            document.getElementById('assessmentStatus').textContent = 'Camera Error';
            document.getElementById('assessmentStatus').className = 'badge bg-danger';
        }
    }
    
    function stopAssessment() {
        assessmentActive = false;
        videoProcessor.stopCapture();
        
        // Update UI
        document.getElementById('startAssessment').disabled = false;
        document.getElementById('stopAssessment').disabled = true;
        document.getElementById('pauseAssessment').disabled = true;
        document.getElementById('assessmentStatus').textContent = 'Assessment Complete';
        document.getElementById('assessmentStatus').className = 'badge bg-primary';
        
        // Generate final results
        generateAssessmentResults();
    }
    
    function pauseAssessment() {
        const pauseBtn = document.getElementById('pauseAssessment');
        if (assessmentActive) {
            assessmentActive = false;
            pauseBtn.innerHTML = '<i class="fas fa-play me-1"></i>Resume';
            document.getElementById('assessmentStatus').textContent = 'Paused';
            document.getElementById('assessmentStatus').className = 'badge bg-warning';
        } else {
            assessmentActive = true;
            pauseBtn.innerHTML = '<i class="fas fa-pause me-1"></i>Pause';
            document.getElementById('assessmentStatus').textContent = 'Assessment Active';
            document.getElementById('assessmentStatus').className = 'badge bg-success';
        }
    }
    
    async function runAssessmentPhases() {
        const phaseDurations = [30, 60, 45, 90, 30]; // seconds for each phase
        const phaseInstructions = [
            "Please look directly at the camera and remain still for calibration.",
            "We'll now assess your current mood. Please answer the questions naturally.",
            "Let's evaluate your stress response patterns.",
            "We'll analyze your communication style and expressions.",
            "Generating your comprehensive assessment report..."
        ];
        
        for (let phase = 1; phase <= 5; phase++) {
            if (!assessmentActive) break;
            
            currentPhase = phase;
            updatePhaseUI(phase, phaseInstructions[phase - 1]);
            
            if (phase === 2 || phase === 3 || phase === 4) {
                await runQuestionsForPhase(phase);
            } else {
                await runTimedPhase(phase, phaseDurations[phase - 1]);
            }
            
            markPhaseComplete(phase);
        }
        
        if (assessmentActive) {
            stopAssessment();
        }
    }
    
    function updatePhaseUI(phase, instruction) {
        // Reset all phases to default state
        for (let i = 1; i <= 5; i++) {
            const phaseElement = document.getElementById(`phase${i}`);
            phaseElement.className = 'assessment-phase p-3 rounded mb-3';
            phaseElement.querySelector('i').className = 'fas fa-clock text-muted';
        }
        
        // Highlight current phase
        const currentPhaseElement = document.getElementById(`phase${phase}`);
        currentPhaseElement.className = 'assessment-phase p-3 rounded mb-3 border-primary bg-primary bg-opacity-10';
        currentPhaseElement.querySelector('i').className = 'fas fa-play text-primary';
        
        // Update instructions
        document.getElementById('instructionText').textContent = instruction;
    }
    
    async function runTimedPhase(phase, duration) {
        const progressBar = document.getElementById(`phase${phase}Progress`);
        const startTime = Date.now();
        
        return new Promise((resolve) => {
            const interval = setInterval(() => {
                if (!assessmentActive) {
                    clearInterval(interval);
                    resolve();
                    return;
                }
                
                const elapsed = (Date.now() - startTime) / 1000;
                const progress = Math.min((elapsed / duration) * 100, 100);
                progressBar.style.width = progress + '%';
                
                if (elapsed >= duration) {
                    clearInterval(interval);
                    resolve();
                }
            }, 100);
        });
    }
    
    async function runQuestionsForPhase(phase) {
        const phaseQuestions = assessmentQuestions.filter(q => q.phase === phase);
        
        document.getElementById('questionSection').style.display = 'block';
        
        for (let i = 0; i < phaseQuestions.length; i++) {
            if (!assessmentActive) break;
            
            await showQuestion(phaseQuestions[i], i, phaseQuestions.length);
            updatePhaseProgress(phase, (i + 1) / phaseQuestions.length * 100);
        }
        
        document.getElementById('questionSection').style.display = 'none';
    }
    
    function showQuestion(questionData, index, total) {
        return new Promise((resolve) => {
            const questionHtml = `
                <div class="mb-4">
                    <h6>Question ${index + 1} of ${total}</h6>
                    <p class="lead">${questionData.question}</p>
                    <p class="text-muted">${questionData.instruction}</p>
                </div>
                
                ${questionData.type === 'scale' ? `
                    <div class="mb-4">
                        <label for="scaleAnswer" class="form-label">Rating (1-10):</label>
                        <input type="range" class="form-range" id="scaleAnswer" min="1" max="10" value="5">
                        <div class="d-flex justify-content-between">
                            <small>1 - Very Low</small>
                            <small id="scaleValue">5</small>
                            <small>10 - Very High</small>
                        </div>
                    </div>
                ` : `
                    <div class="mb-4">
                        <textarea class="form-control" id="openAnswer" rows="4" 
                                placeholder="Share your thoughts..."></textarea>
                    </div>
                `}
                
                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="skipQuestion()">Skip</button>
                    <button class="btn btn-primary" onclick="submitAnswer()">Next</button>
                </div>
            `;
            
            document.getElementById('currentQuestion').innerHTML = questionHtml;
            document.getElementById('questionProgress').style.width = ((index + 1) / total * 100) + '%';
            
            if (questionData.type === 'scale') {
                const scaleInput = document.getElementById('scaleAnswer');
                const scaleValue = document.getElementById('scaleValue');
                scaleInput.addEventListener('input', function() {
                    scaleValue.textContent = this.value;
                });
            }
            
            // Global functions for question handling
            window.submitAnswer = function() {
                let answer;
                if (questionData.type === 'scale') {
                    answer = document.getElementById('scaleAnswer').value;
                } else {
                    answer = document.getElementById('openAnswer').value;
                }
                
                assessmentData[`question_${index}`] = {
                    question: questionData.question,
                    answer: answer,
                    timestamp: Date.now()
                };
                
                resolve();
            };
            
            window.skipQuestion = function() {
                assessmentData[`question_${index}`] = {
                    question: questionData.question,
                    answer: 'skipped',
                    timestamp: Date.now()
                };
                resolve();
            };
            
            // Auto-advance after 2 minutes if no response
            setTimeout(() => {
                if (document.getElementById('currentQuestion').innerHTML === questionHtml) {
                    window.skipQuestion();
                }
            }, 120000);
        });
    }
    
    function updatePhaseProgress(phase, progress) {
        document.getElementById(`phase${phase}Progress`).style.width = progress + '%';
    }
    
    function markPhaseComplete(phase) {
        const phaseElement = document.getElementById(`phase${phase}`);
        phaseElement.className = 'assessment-complete p-3 rounded mb-3';
        phaseElement.querySelector('i').className = 'fas fa-check text-success';
        document.getElementById(`phase${phase}Progress`).style.width = '100%';
    }
    
    async function startRealTimeAnalysis() {
        const analysisInterval = setInterval(async () => {
            if (!assessmentActive) {
                clearInterval(analysisInterval);
                return;
            }
            
            try {
                // Get current video frame
                const frameData = await videoProcessor.getCurrentFrame();
                
                if (frameData) {
                    // Send to analysis endpoint
                    const response = await fetch('/api/video-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            frame_data: frameData,
                            phase: currentPhase,
                            enable_microexpression: document.getElementById('enableMicroexpression').checked
                        })
                    });
                    
                    const analysis = await response.json();
                    updateRealTimeDisplay(analysis);
                }
            } catch (error) {
                console.error('Real-time analysis error:', error);
            }
        }, 2000); // Analyze every 2 seconds
    }
    
    function updateRealTimeDisplay(analysis) {
        if (analysis.emotions) {
            const primaryEmotion = Object.keys(analysis.emotions).reduce((a, b) => 
                analysis.emotions[a] > analysis.emotions[b] ? a : b
            );
            
            document.getElementById('primaryEmotion').textContent = primaryEmotion;
            document.getElementById('emotionConfidence').style.width = 
                (analysis.emotions[primaryEmotion] * 100) + '%';
            
            // Update emotion indicator color
            const emotionColors = {
                'happy': '#28a745',
                'sad': '#6c757d',
                'angry': '#dc3545',
                'fearful': '#ffc107',
                'surprised': '#17a2b8',
                'disgusted': '#6f42c1',
                'neutral': '#007bff'
            };
            document.getElementById('emotionIndicator').style.backgroundColor = 
                emotionColors[primaryEmotion] || '#007bff';
        }
        
        // Update stress level
        if (analysis.stress_level !== undefined) {
            const stressLevels = ['Very Low', 'Low', 'Moderate', 'High', 'Very High'];
            const stressIndex = Math.floor(analysis.stress_level * 5);
            document.getElementById('stressLevel').textContent = stressLevels[stressIndex] || 'Low';
            document.getElementById('stressConfidence').style.width = (analysis.stress_level * 100) + '%';
        }
        
        // Show microexpression alerts
        if (analysis.microexpressions && Object.keys(analysis.microexpressions).length > 0) {
            showMicroexpressionAlert(analysis.microexpressions);
        }
    }
    
    function showMicroexpressionAlert(microexpressions) {
        const alert = document.getElementById('microAlert');
        const text = document.getElementById('microText');
        
        const expressions = Object.keys(microexpressions);
        if (expressions.length > 0) {
            text.textContent = `Detected: ${expressions.join(', ')}`;
            alert.classList.add('show');
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
    }
    
    // Mock real-time analysis for test mode
    function startMockRealTimeAnalysis() {
        const emotions = ['happy', 'neutral', 'sad', 'anxious', 'calm'];
        const stressLevels = [0.2, 0.3, 0.4, 0.5, 0.6];
        
        const analysisInterval = setInterval(() => {
            if (!assessmentActive) {
                clearInterval(analysisInterval);
                return;
            }
            
            // Generate mock analysis data
            const mockAnalysis = {
                emotions: {
                    [emotions[Math.floor(Math.random() * emotions.length)]]: Math.random() * 0.5 + 0.5,
                    neutral: Math.random() * 0.3
                },
                stress_level: stressLevels[Math.floor(Math.random() * stressLevels.length)],
                engagement_level: Math.random() * 0.4 + 0.6
            };
            
            updateRealTimeDisplay(mockAnalysis);
        }, 2000);
    }
    
    async function generateAssessmentResults() {
        document.getElementById('resultsSection').style.display = 'block';
        
        try {
            // Send comprehensive assessment data
            const response = await fetch('/api/video-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assessment_complete: true,
                    assessment_data: assessmentData,
                    duration: Date.now() - assessmentStartTime
                })
            });
            
            const results = await response.json();
            displayAssessmentResults(results);
            
        } catch (error) {
            console.error('Error generating results:', error);
            document.getElementById('assessmentResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error generating assessment results. Please try again.
                </div>
            `;
        }
    }
    
    function displayAssessmentResults(results) {
        const resultsHtml = `
            <div class="row g-4 mb-4">
                <div class="col-md-3 text-center">
                    <div class="card bg-dark border-0">
                        <div class="card-body">
                            <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                            <h4>${results.overall_score || 75}%</h4>
                            <small class="text-muted">Overall Wellness</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-dark border-0">
                        <div class="card-body">
                            <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                            <h4>${results.emotional_stability || 'Good'}</h4>
                            <small class="text-muted">Emotional Stability</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-dark border-0">
                        <div class="card-body">
                            <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                            <h4>${results.stress_resilience || 'Moderate'}</h4>
                            <small class="text-muted">Stress Resilience</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-dark border-0">
                        <div class="card-body">
                            <i class="fas fa-comments fa-2x text-info mb-2"></i>
                            <h4>${results.communication_style || 'Open'}</h4>
                            <small class="text-muted">Communication</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <h6><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                    <ul class="list-unstyled">
                        ${(results.insights || [
                            'Strong emotional awareness demonstrated',
                            'Good eye contact and engagement',
                            'Moderate stress response patterns',
                            'Effective communication style'
                        ]).map(insight => `<li><i class="fas fa-check text-success me-2"></i>${insight}</li>`).join('')}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Areas for Focus</h6>
                    <ul class="list-unstyled">
                        ${(results.recommendations || [
                            'Practice stress management techniques',
                            'Continue with regular therapy sessions',
                            'Monitor mood patterns',
                            'Maintain social connections'
                        ]).map(rec => `<li><i class="fas fa-arrow-right text-warning me-2"></i>${rec}</li>`).join('')}
                    </ul>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                    <button class="btn btn-primary" onclick="downloadResults()">
                        <i class="fas fa-download me-1"></i>Download Report
                    </button>
                    <button class="btn btn-outline-info" onclick="scheduleFollowUp()">
                        <i class="fas fa-calendar me-1"></i>Schedule Follow-up
                    </button>
                </div>
                <div>
                    <a href="{{ url_for('individual_therapy') }}" class="btn btn-success">
                        <i class="fas fa-comments me-1"></i>Start Therapy Session
                    </a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-line me-1"></i>View Dashboard
                    </a>
                </div>
            </div>
        `;
        
        document.getElementById('assessmentResults').innerHTML = resultsHtml;
    }
    
    function showSettings() {
        const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
        modal.show();
    }
    
    function saveSettings() {
        // Save settings logic would go here
        const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        modal.hide();
        
        // Show confirmation
        const toast = document.createElement('div');
        toast.className = 'toast-container position-fixed top-0 end-0 p-3';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-body">
                    <i class="fas fa-check text-success me-2"></i>Settings saved successfully!
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    }
    
    // Global functions for results interaction
    window.downloadResults = function() {
        // Implementation for downloading results
        console.log('Downloading assessment results...');
    };
    
    window.scheduleFollowUp = function() {
        // Implementation for scheduling follow-up
        console.log('Scheduling follow-up appointment...');
    };
    
    let assessmentStartTime;
    
    // Track assessment start time
    document.getElementById('startAssessment').addEventListener('click', function() {
        assessmentStartTime = Date.now();
    });
});
</script>
{% endblock %}
